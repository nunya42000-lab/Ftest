<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevOS Workspace</title>
    <link rel="manifest" href="./manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jshint/2.13.6/jshint.min.js"></script>
    <style>
        :root { --bg: #0d1117; --panel: #161b22; --accent: #2f81f7; --success: #238636; --danger: #f85149; --warn: #d29922; --text: #c9d1d9; --border: #30363d; --muted: #8b949e; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        header { background: var(--panel); padding: 10px 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .header-left { display: flex; align-items: center; gap: 10px; }
        .menu-btn { background: transparent; border: 1px solid var(--border); color: var(--text); font-size: 18px; padding: 4px 10px; border-radius: 4px; cursor: pointer; }
        
        .tabs { display: flex; gap: 8px; overflow-x: auto; white-space: nowrap; padding: 10px 15px; background: var(--panel); border-bottom: 1px solid var(--border); }
        .tab { padding: 8px 12px; background: #000; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: bold; }
        .tab.active { background: var(--accent); color: #fff; border-color: var(--accent); }

        .workspace { display: flex; flex: 1; overflow: hidden; position: relative; }
        
        /* Slide-out Sidebar UI */
        .sidebar { position: absolute; z-index: 100; left: -250px; top: 0; width: 220px; height: 100%; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; transition: left 0.3s ease; box-shadow: 5px 0 15px rgba(0,0,0,0.5); }
        .sidebar.open { left: 0; }
        .scrim { position: absolute; inset: 0; background: rgba(0,0,0,0.6); z-index: 90; display: none; opacity: 0; transition: opacity 0.3s ease; }
        .scrim.active { display: block; opacity: 1; }

        .file-list { flex: 1; padding: 10px; overflow-y: auto; font-size: 12px; font-family: 'Fira Code', monospace; }
        .file-item { padding: 8px 6px; cursor: pointer; border-radius: 4px; border: 1px solid transparent; margin-bottom: 2px; word-break: break-all; }
        .file-item:hover { background: #1c2128; }
        .file-item.active { background: #1f6feb33; border-color: var(--accent); color: #58a6ff; }

        .main-view { flex: 1; display: flex; flex-direction: column; padding: 15px; overflow-y: auto; width: 100%; }
        .editor-container { display: flex; flex: 1; overflow: hidden; background: #000; border: 1px solid var(--border); border-radius: 6px; }
        #line-numbers { padding: 12px 5px; background: #161b22; color: #8b949e; text-align: right; font-family: 'Fira Code', monospace; font-size: 13px; line-height: 1.5; overflow: hidden; user-select: none; border-right: 1px solid #30363d; min-width: 30px; }
        textarea#main-editor { flex: 1; background: transparent; color: #d1d5da; border: none; font-family: 'Fira Code', monospace; padding: 12px; font-size: 13px; line-height: 1.5; resize: none; outline: none; white-space: pre; overflow: auto; }
        
        .panel-box { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 15px; display: none; flex-direction: column; height: 100%; box-sizing: border-box; }
        .panel-box.active { display: flex; }
        
        button { padding: 12px 15px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; font-size: 12px; transition: 0.2s; }
        .btn-primary { background: var(--success); color: white; }
        .btn-action { background: var(--accent); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warn { background: var(--warn); color: #000; }
        .btn-outline { background: #21262d; color: var(--text); border: 1px solid var(--border); }

        .file-upload-wrapper { padding: 15px; background: #21262d; text-align: center; border-bottom: 1px solid var(--border); position: relative; }
        .file-upload-wrapper input[type=file] { position: absolute; inset: 0; opacity: 0; cursor: pointer; height: 100%; width: 100%; }
        
        .search-match { background: var(--accent); color: #000; padding: 0 2px; border-radius: 2px; font-weight: bold; }
        .search-result-item { padding: 6px; cursor: pointer; border-radius: 4px; margin-bottom: 4px; border: 1px solid transparent; }
        .search-result-item:hover { background: #1c2128; border-color: var(--border); }
    </style>
</head>
<body>

<header>
    <div class="header-left">
        <button class="menu-btn" onclick="openSidebar()">‚ò∞</button>
        <div style="font-weight: bold; font-size: 16px;">DevOS</div>
    </div>
    <button class="btn-primary" style="padding: 8px 12px;" onclick="exportProject()">ZIP & EXPORT</button>
</header>

<div class="tabs">
    <div class="tab active" onclick="switchTab('editor')">1. Editor</div>
    <div class="tab" onclick="switchTab('linter')">2. Debugger</div>
    <div class="tab" onclick="switchTab('search')">3. Search</div>
    <div class="tab" onclick="switchTab('router')">4. Router</div>
</div>

<div class="workspace">
    <div class="scrim" id="ui-scrim" onclick="closeSidebar()"></div>
    
    <aside class="sidebar" id="ui-sidebar">
        <div class="file-upload-wrapper">
            <span style="font-size: 12px; font-weight: bold; color: var(--accent);">üìÅ LOAD FILES</span>
            <input type="file" multiple id="file-input" onchange="loadFiles(event)">
        </div>
        <div class="file-list" id="file-explorer">
            <div style="color:var(--muted); text-align:center; margin-top:20px;">No files loaded</div>
        </div>
    </aside>

    <main class="main-view">
        <div id="view-editor" class="panel-box active">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <strong id="current-file-label" style="color:var(--accent); font-size: 14px;">Select a file (‚ò∞)</strong>
                <button class="btn-outline" style="padding: 6px 12px;" onclick="saveCurrentFile()">Save to RAM</button>
            </div>
            <div class="editor-container">
                <div id="line-numbers">1</div>
                <textarea id="main-editor" wrap="off" oninput="updateEditorSync()" onscroll="syncEditorScroll()"></textarea>
            </div>
        </div>

        <div id="view-linter" class="panel-box">
            <h3 style="margin-top:0; color:var(--danger)">Syntax & Error Inspector</h3>
            <div style="margin-bottom: 10px;"><strong>Target: </strong><span id="linter-target-label" style="color:var(--accent);">None</span></div>
            <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                <button class="btn-danger" style="flex: 1;" onclick="runLinter()">SCAN ERRORS</button>
                <button class="btn-warn" id="btn-autofix" style="flex: 1; display: none;" onclick="autoFixBasicErrors()">AUTO-FIX</button>
            </div>
            <div id="linter-results" style="flex: 1; background:#000; border:1px solid var(--border); border-radius:6px; overflow-y:auto; padding:12px; font-family:monospace; font-size:12px;">Awaiting scan...</div>
        </div>

        <div id="view-search" class="panel-box">
            <h3 style="margin-top:0; color:var(--accent)">Global Find & Replace</h3>
            <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
                <input type="text" id="search-query" placeholder="Find text..." style="padding:12px; background:#000; border:1px solid var(--border); color:#fff; font-family: 'Fira Code', monospace; border-radius: 4px;">
                <input type="text" id="replace-query" placeholder="Replace with..." style="padding:12px; background:#000; border:1px solid var(--border); color:#fff; font-family: 'Fira Code', monospace; border-radius: 4px;">
            </div>
            <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                <button class="btn-outline" style="flex: 1;" onclick="performSearch()">FIND ALL</button>
                <button class="btn-warn" style="flex: 1;" onclick="performReplace()">REPLACE ALL</button>
            </div>
            <div id="search-results" style="flex: 1; background:#000; border:1px solid var(--border); border-radius:6px; overflow-y:auto; padding:12px; font-family:'Fira Code', monospace; font-size:12px;">
                <span style="color: var(--muted)">Enter a query to search across all loaded files.</span>
            </div>
        </div>

        <div id="view-router" class="panel-box">
            <h3 style="margin-top:0; color:var(--accent)">Auto-Router</h3>
            <textarea id="router-input" style="height: 180px; flex: none; background:#000; color:#fff; padding:10px; border:1px solid var(--border);"></textarea>
            <select id="router-target" style="background:#000; color:#fff; padding:10px; border:1px solid var(--border); border-radius:4px; width:100%; margin-top:10px; font-family: monospace;"></select>
            <button class="btn-action" style="margin-top: 15px; width: 100%;" onclick="routeCode()">INJECT CODE</button>
            <div id="router-log" style="margin-top:15px; font-family:monospace; font-size:12px; color:var(--success); background: #000; padding: 10px; display: none;"></div>
        </div>
    </main>
</div>

<script>
    // Explicit Sidebar Controls
    function openSidebar() {
        document.getElementById('ui-sidebar').classList.add('open');
        document.getElementById('ui-scrim').classList.add('active');
    }
    function closeSidebar() {
        document.getElementById('ui-sidebar').classList.remove('open');
        document.getElementById('ui-scrim').classList.remove('active');
    }

    let vfs = {};
    let currentFileName = null;
    let fixableErrors = [];

    function updateEditorSync() {
        const textarea = document.getElementById('main-editor');
        const linesCount = textarea.value.split('\n').length;
        document.getElementById('line-numbers').innerHTML = Array.from({length: linesCount}, (_, i) => i + 1).join('<br>');
    }
    function syncEditorScroll() { document.getElementById('line-numbers').scrollTop = document.getElementById('main-editor').scrollTop; }

    function switchTab(tabId) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.panel-box').forEach(p => p.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('view-' + tabId).classList.add('active');
        if(tabId === 'linter') document.getElementById('linter-target-label').innerText = currentFileName || "None Selected";
        if(tabId === 'editor') updateEditorSync();
    }

    // Safely Load Files
    function loadFiles(event) {
        try {
            const fileList = event.target.files;
            if(!fileList || fileList.length === 0) {
                alert("No files selected or browser blocked access.");
                return;
            }

            const files = Array.from(fileList).sort((a, b) => a.name.localeCompare(b.name));
            vfs = {}; 
            document.getElementById('file-explorer').innerHTML = ''; 
            document.getElementById('router-target').innerHTML = '';
            
            let loaded = 0;
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    vfs[file.name] = e.target.result || '';
                    addFileToSidebar(file.name);
                    loaded++;
                    if(loaded === files.length) {
                        openFile(files[0].name, document.querySelector('.file-item'));
                        openSidebar(); // Explicitly ensure it opens
                        alert(`Successfully loaded ${files.length} files into RAM.`);
                    }
                };
                reader.onerror = () => alert(`Error reading file: ${file.name}`);
                reader.readAsText(file);
            });
        } catch (err) {
            alert(`File System Error: ${err.message}`);
        }
    }

    function addFileToSidebar(filename) {
        const div = document.createElement('div');
        div.className = 'file-item'; div.innerText = filename;
        div.onclick = () => { 
            openFile(filename, div); 
            closeSidebar(); // Explicitly close when file is picked
        };
        document.getElementById('file-explorer').appendChild(div);
        if(filename.endsWith('.js') || filename.endsWith('.json')) {
            const opt = document.createElement('option'); opt.value = filename; opt.innerText = filename;
            document.getElementById('router-target').appendChild(opt);
        }
    }

    function openFile(filename, element) {
        if(currentFileName) saveCurrentFile();
        currentFileName = filename;
        document.getElementById('main-editor').value = vfs[filename] || '';
        document.getElementById('current-file-label').innerText = filename;
        
        document.querySelectorAll('.file-item').forEach(el => {
            if (el.innerText === filename) el.classList.add('active');
            else el.classList.remove('active');
        });
        updateEditorSync();
    }

    function saveCurrentFile() { if(currentFileName) vfs[currentFileName] = document.getElementById('main-editor').value; }

    // --- Core Logic functions (Linter, Search, Router, Export) unchanged for safety ---
    function runLinter() {
        saveCurrentFile();
        JSHINT(vfs[currentFileName], { esversion: 11, browser: true, module: true, devel: true, undef: true });
        fixableErrors = [];
        let html = '';
        if (JSHINT.errors.length > 0) {
            JSHINT.errors.forEach(err => {
                if (err) {
                    const isFixable = err.code === 'W033' || err.code === 'W069';
                    if (isFixable) fixableErrors.push(err);
                    html += `<div class="error-item"><span class="error-line">Line ${err.line}:</span> ${err.reason} ${isFixable ? '[Fixable]' : ''}</div>`;
                }
            });
            document.getElementById('linter-results').innerHTML = html;
            document.getElementById('btn-autofix').style.display = fixableErrors.length > 0 ? 'block' : 'none';
        } else {
            document.getElementById('linter-results').innerHTML = `<div style="color:var(--success)">‚úî 0 Syntax Errors.</div>`;
            document.getElementById('btn-autofix').style.display = 'none';
        }
    }

    function autoFixBasicErrors() {
        let lines = vfs[currentFileName].split('\n');
        fixableErrors.sort((a, b) => b.line - a.line).forEach(err => {
            const idx = err.line - 1;
            if (err.code === 'W033') lines[idx] = lines[idx].replace(/\s+$/, '') + ';';
            if (err.code === 'W069') lines[idx] = lines[idx].replace(/\[(['"])([a-zA-Z_$][0-9a-zA-Z_$]*)\1\]/g, '.$2');
        });
        vfs[currentFileName] = lines.join('\n');
        document.getElementById('main-editor').value = vfs[currentFileName];
        updateEditorSync(); runLinter();
    }

    function escapeRegExp(string) { return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

    function performSearch() {
        if(currentFileName) saveCurrentFile(); 
        const query = document.getElementById('search-query').value;
        const resultsBox = document.getElementById('search-results');
        if(!query) return resultsBox.innerHTML = '<span style="color:var(--danger)">Please enter a search term.</span>';

        let html = ''; let totalMatches = 0;
        const regex = new RegExp(escapeRegExp(query), 'gi');

        for (const [filename, content] of Object.entries(vfs)) {
            const lines = content.split('\n');
            let fileMatchesHtml = '';
            
            lines.forEach((line, index) => {
                if(line.toLowerCase().includes(query.toLowerCase())) {
                    totalMatches++;
                    const highlighted = line.replace(regex, `<span class="search-match">$&</span>`);
                    fileMatchesHtml += `<div class="search-result-item" onclick="openFile('${filename}'); switchTab('editor'); closeSidebar();"><span style="color:var(--warn); margin-right:5px;">Line ${index + 1}:</span><span style="color:var(--text)">${highlighted.trim().substring(0, 100)}${line.length > 100 ? '...' : ''}</span></div>`;
                }
            });
            if (fileMatchesHtml) html += `<div style="margin-bottom: 15px; background: #1c2128; border: 1px solid var(--border); border-radius: 4px; padding: 8px;"><strong style="color:var(--success); display:block; margin-bottom:5px; border-bottom: 1px solid var(--border); padding-bottom:5px;">üìÅ ${filename}</strong>${fileMatchesHtml}</div>`;
        }

        if (totalMatches === 0) resultsBox.innerHTML = '<span style="color:var(--muted)">No matches found.</span>';
        else resultsBox.innerHTML = `<div style="margin-bottom: 10px; color:var(--accent); font-weight:bold;">Found ${totalMatches} instances:</div>` + html;
    }

    function performReplace() {
        if(currentFileName) saveCurrentFile();
        const query = document.getElementById('search-query').value;
        const replacement = document.getElementById('replace-query').value;
        if(!query) return alert("Please enter a search term.");
        if(!confirm(`DANGER ZONE: Replace ALL instances of "${query}" with "${replacement}" across every file?`)) return;

        let replaceCount = 0; let filesChanged = 0;
        for (const filename of Object.keys(vfs)) {
            if(vfs[filename].includes(query)) {
                filesChanged++;
                const parts = vfs[filename].split(query);
                replaceCount += parts.length - 1;
                vfs[filename] = parts.join(replacement); 
            }
        }

        if (currentFileName) {
            document.getElementById('main-editor').value = vfs[currentFileName];
            updateEditorSync();
        }
        alert(`Successfully refactored ${replaceCount} instances across ${filesChanged} files.`);
        performSearch(); 
    }

    function routeCode() {
        const input = document.getElementById('router-input').value.trim();
        const targetFile = document.getElementById('router-target').value;
        const nameMatch = input.match(/(?:function\s+([\w$]+)|(?:const|let|var)\s+([\w$]+)\s*=)/);
        if(!nameMatch) return alert("Error: Could not detect function name.");
        const name = nameMatch[1] || nameMatch[2];
        
        let code = input.startsWith('export') ? input : `export ${input}`;
        vfs[targetFile] = (vfs[targetFile] || '') + `\n\n/* Auto-Routed */\n${code}`;
        
        const log = document.getElementById('router-log');
        log.style.display = 'block';
        log.innerHTML = `Injected <b>${name}</b> into ${targetFile}.<br><input type="text" value="import { ${name} } from './${targetFile}';" style="width:100%; background:#1c2128; color:var(--accent); margin-top:5px;" readonly onclick="this.select(); document.execCommand('copy');">`;
        document.getElementById('router-input').value = '';
        if(currentFileName === targetFile) openFile(targetFile);
    }

    async function exportProject() {
        if(currentFileName) saveCurrentFile(); 
        const zip = new JSZip();
        for (const [filename, content] of Object.entries(vfs)) zip.file(filename, content);
        const content = await zip.generateAsync({type: "blob"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(content); a.download = "DevOS_Project.zip"; a.click();
    }
</script>
</body>
</html>
