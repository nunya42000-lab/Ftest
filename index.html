<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Follow Me</title>
    
    <meta name="theme-color" content="#4f46e5">

    <link rel="manifest" href="manifest.json">

    <link rel="apple-touch-icon" href="https://placehold.co/180x180/4f46e5/ffffff?text=F&font=inter">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // --- Tailwind Configuration ---
        tailwind.config = {
            darkMode: 'class', // Enable class-based dark mode
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // Base Colors
                        'primary-app': '#4f46e5', // Indigo
                        'secondary-app': '#6366f1',
                        'accent-app': '#a5b4fc',
                        
                        // Control Button Colors (fixed for consistency)
                        'btn-control-red': '#dc2626', 
                        'btn-control-red-active': '#b91c1c',
                        'btn-control-blue': '#2563eb', 
                        'btn-control-blue-active': '#1e40af',
                    }
                }
            }
        }
    </script>
    
    <link rel="stylesheet" href="style.css">
</head>
<body class="dark min-h-screen flex flex-col font-sans p-4">

    <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full transform scale-90 transition-transform duration-300">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-gray-900 dark:text-white"></h3>
            <p id="modal-message" class="text-gray-700 dark:text-gray-300 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"></button>
                <button id="modal-confirm" class="px-4 py-2 text-white bg-primary-app rounded-lg hover:bg-secondary-app transition-colors"></button>
            </div>
        </div>
    </div>
    
    <div id="settings-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full m-4 transform scale-90 transition-transform duration-300 flex flex-col max-h-[90vh] overflow-hidden">
            
            <div class="p-6 pb-4 relative">
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white border-b border-gray-200 dark:border-gray-700 pb-3">App Settings ‚öôÔ∏è</h3>
                <button id="open-help-button" data-action="open-help" class="absolute top-4 right-4 text-gray-700 dark:text-gray-300 hover:text-primary-app dark:hover:text-primary-app transition-colors text-2xl font-bold focus:outline-none" title="View Help & Instructions">
                    ‚ùì
                </button>
            </div>

            <div class="p-6 pt-2 overflow-y-auto flex-grow">
                
                <div class="mb-6">
                    <label class="block text-gray-700 dark:text-gray-300 text-lg font-semibold mb-2">Current Mode</label>
                    <button id="settings-mode-toggle-button" 
                            data-action="mode-toggle-dropdown"
                            class="btn-input !bg-primary-app hover:!bg-secondary-app text-white text-base font-extrabold px-4 flex items-center justify-between w-full h-12">
                        Loading...
                        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="settings-mode-dropdown" class="absolute mt-2 w-full bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl shadow-lg overflow-hidden z-20 hidden">
                        </div>
                </div>
                
                <div class="mb-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <p class="block text-gray-700 dark:text-gray-300 text-xl font-bold mb-4">Follows Mode Settings</p>
                    <div id="follows-count-setting" class="mb-6">
                        <label for="follows-count-select" class="block text-gray-700 dark:text-gray-300 text-lg font-semibold mb-2">Follows Sequences</label>
                        <select id="follows-count-select" class="w-full h-12 px-4 py-2 text-lg font-semibold text-gray-900 dark:text-white bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-app">
                            <option value="2">2 Sequences</option>
                            <option value="3">3 Sequences</option>
                            <option value="4">4 Sequences</option>
                        </select>
                    </div>
                    
                    <div id="follows-chunk-setting" class="mb-6">
                        <label for="follows-chunk-size-select" class="block text-gray-700 dark:text-gray-300 text-lg font-semibold mb-2">Numbers per sequence (playback)</label>
                        <select id="follows-chunk-size-select" class="w-full h-12 px-4 py-2 text-lg font-semibold text-gray-900 dark:text-white bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-app">
                            <option value="2">2</option>
                            <option value="3" selected>3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </div>
                </div>

                <div class="mb-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <p class="block text-gray-700 dark:text-gray-300 text-xl font-bold mb-4">Toggles</p>
                    
                    <div class="flex items-center justify-between mb-6">
                        <label for="dark-mode-toggle" class="text-gray-700 dark:text-gray-300 text-lg font-semibold">Dark Mode</label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="dark-mode-toggle" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-app/50 dark:peer-focus:ring-primary-app rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-app"></div>
                        </label>
                    </div>
                    
                    <div class="flex items-center justify-between mb-6">
                        <label for="speed-delete-toggle" class="text-gray-700 dark:text-gray-300 text-lg font-semibold">Speed Deleting</label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="speed-delete-toggle" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-app/50 dark:peer-focus:ring-primary-app rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-app"></div>
                        </label>
                    </div>
                    
                    <div class="flex items-center justify-between mb-6">
                        <label for="audio-playback-toggle" class="text-gray-700 dark:text-gray-300 text-lg font-semibold">Audio Playback (Speak)</label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="audio-playback-toggle" class="sr-only peer" checked> 
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-app/50 dark:peer-focus:ring-primary-app rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-app"></div>
                        </label>
                    </div>
                    
                    <div class="flex items-center justify-between mb-6">
                        <label for="voice-input-toggle" class="text-gray-700 dark:text-gray-300 text-lg font-semibold">Voice Input (Mic)</label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="voice-input-toggle" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-app/50 dark:peer-focus:ring-primary-app rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-app"></div>
                        </label>
                    </div>

                    <div class="flex items-center justify-between mb-6">
                        <label for="slider-lock-toggle" class="text-gray-700 dark:text-gray-300 text-lg font-semibold">Lock Sliders</label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="slider-lock-toggle" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-app/50 dark:peer-focus:ring-primary-app rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-app"></div>
                        </label>
                    </div>
                    
                    <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between mb-6">
                            <label for="bananas-autoplay-toggle" class="text-gray-700 dark:text-gray-300 text-lg font-semibold">Bananas Autoplay</label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="bananas-autoplay-toggle" class="sr-only peer" checked> 
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-app/50 dark:peer-focus:ring-primary-app rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-app"></div>
                            </label>
                        </div>
                        
                        <div class="flex items-center justify-between mb-6">
                            <label for="follows-autoplay-toggle" class="text-gray-700 dark:text-gray-300 text-lg font-semibold">Follows Autoplay</label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="follows-autoplay-toggle" class="sr-only peer" checked> 
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-app/50 dark:peer-focus:ring-primary-app rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-app"></div>
                            </label>
                        </div>
                        
                        <div class="flex items-center justify-between mb-6">
                            <label for="piano-autoplay-toggle" class="text-gray-700 dark:text-gray-300 text-lg font-semibold">Piano Autoplay</label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="piano-autoplay-toggle" class="sr-only peer" checked> 
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-app/50 dark:peer-focus:ring-primary-app rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-app"></div>
                            </label>
                        </div>
                        
                        <div class="flex items-center justify-between mb-8">
                            <label for="rounds15-clear-after-playback-toggle" class="text-gray-700 dark:text-gray-300 text-lg font-semibold">15 rounds Auto-Clear/Advance</label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="rounds15-clear-after-playback-toggle" class="sr-only peer" checked> 
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-app/50 dark:peer-focus:ring-primary-app rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-app"></div>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="mb-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <p class="block text-gray-700 dark:text-gray-300 text-xl font-bold mb-4">Playback & Size Controls</p>
                    
                    <div class="mb-6">
                        <label for="bananas-speed-slider" class="block text-gray-700 dark:text-gray-300 text-lg font-semibold mb-2">Bananas/Follows Play Speed</label>
                        <input type="range" id="bananas-speed-slider" min="50" max="150" value="100" class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg disabled:opacity-50">
                        <div class="flex justify-between text-sm text-gray-500 dark:text-gray-400 mt-2">
                            <span>50% (Slow)</span>
                            <span id="bananas-speed-display">100% (Base)</span>
                            <span>150% (Fast)</span>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label for="piano-speed-slider" class="block text-gray-700 dark:text-gray-300 text-lg font-semibold mb-2">Piano Play Speed</label>
                        <input type="range" id="piano-speed-slider" min="50" max="150" value="100" class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg disabled:opacity-50">
                        <div class="flex justify-between text-sm text-gray-500 dark:text-gray-400 mt-2">
                            <span>50% (Slow)</span>
                            <span id="piano-speed-display">100% (Base)</span>
                            <span>150% (Fast)</span>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label for="rounds15-speed-slider" class="block text-gray-700 dark:text-gray-300 text-lg font-semibold mb-2">15 rounds Play Speed</label>
                        <input type="range" id="rounds15-speed-slider" min="50" max="150" value="100" class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg disabled:opacity-50">
                        <div class="flex justify-between text-sm text-gray-500 dark:text-gray-400 mt-2">
                            <span>50% (Slow)</span>
                            <span id="rounds15-speed-display">100% (Base)</span>
                            <span>150% (Fast)</span>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label for="ui-scale-slider" class="block text-gray-700 dark:text-gray-300 text-lg font-semibold mb-2">Sequence Size</label>
                        <input type="range" id="ui-scale-slider" min="50" max="200" value="100" class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg disabled:opacity-50">
                        <div class="flex justify-between text-sm text-gray-500 dark:text-gray-400 mt-2">
                            <span>50% (Small)</span>
                            <span id="ui-scale-display">100% (Base)</span>
                            <span>200% (Large)</span>
                        </div>
                    </div>
                </div>
                
            </div>
            
            <div class="p-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                <div class="flex justify-end">
                    <button id="close-settings" class="px-6 py-2 text-white bg-gray-500 rounded-lg hover:bg-gray-600 transition-colors font-semibold">Close</button>
                </div>
            </div>
            
        </div>
    </div>
    
    <div id="help-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-lg w-full m-4 transform scale-90 transition-transform duration-300 flex flex-col max-h-[90vh] overflow-hidden">
            
            <div class="p-6 pb-4">
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white border-b border-gray-200 dark:border-gray-700 pb-3">Application Instructions & Help üìö</h3>
            </div>

            <div class="p-6 pt-2 overflow-y-auto flex-grow text-gray-700 dark:text-gray-300 text-base" id="help-content">
                </div>

            <div class="p-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                <div class="flex justify-end">
                    <button id="close-help" class="px-6 py-2 text-white bg-primary-app rounded-lg hover:bg-secondary-app transition-colors font-semibold">Got it!</button>
                </div>
            </div>
            
        </div>
    </div>
    <div id="app" class="max-w-7xl w-full mx-auto flex flex-col flex-grow">
        
        <main id="sequence-container" class="flex-grow mb-6 transition-all duration-300 pt-1">
            </main>

        <footer id="input-footer" class="sticky bottom-0 left-0 right-0 p-4 rounded-xl shadow-2xl border-t-4 border-primary-app">
            
            <div id="bananas-pad" class="max-w-xs mx-auto">
                <div class="grid grid-cols-3 gap-3 mb-3">
                    <button data-value="1" data-mode="bananas" class="btn-input btn-pad-number">1</button>
                    <button data-value="2" data-mode="bananas" class="btn-input btn-pad-number">2</button>
                    <button data-value="3" data-mode="bananas" class="btn-input btn-pad-number">3</button>
                    <button data-value="4" data-mode="bananas" class="btn-input btn-pad-number">4</button>
                    <button data-value="5" data-mode="bananas" class="btn-input btn-pad-number">5</button>
                    <button data-value="6" data-mode="bananas" class="btn-input btn-pad-number">6</button>
                    <button data-value="7" data-mode="bananas" class="btn-input btn-pad-number">7</button>
                    <button data-value="8" data-mode="bananas" class="btn-input btn-pad-number">8</button>
                    <button data-value="9" data-mode="bananas" class="btn-input btn-pad-number">9</button>
                </div>
                <div class="grid grid-cols-4 gap-3">
                    <button data-action="play-demo" data-mode="bananas" class="btn-input btn-control !bg-primary-app hover:!bg-secondary-app text-2xl">‚ñ∂</button> 
                    <button data-action="voice-input" data-mode="bananas" class="btn-input btn-control !bg-primary-app hover:!bg-secondary-app text-2xl hidden" title="Voice Input">üé§</button>
                    <button id="backspace-button-bananas" data-action="backspace" data-mode="bananas" class="btn-input btn-control text-2xl">&larr;</button>
                    <button data-action="open-settings" data-mode="bananas" class="btn-input btn-control !bg-primary-app hover:!bg-secondary-app text-2xl">‚öôÔ∏è</button>
                </div>
            </div>

            <div id="follows-pad" class="max-w-xs mx-auto" style="display: none;">
                <div class="grid grid-cols-3 gap-3 mb-3">
                    <button data-value="1" data-mode="follows" class="btn-input btn-pad-number">1</button>
                    <button data-value="2" data-mode="follows" class="btn-input btn-pad-number">2</button>
                    <button data-value="3" data-mode="follows" class="btn-input btn-pad-number">3</button>
                    <button data-value="4" data-mode="follows" class="btn-input btn-pad-number">4</button>
                    <button data-value="5" data-mode="follows" class="btn-input btn-pad-number">5</button>
                    <button data-value="6" data-mode="follows" class="btn-input btn-pad-number">6</button>
                    <button data-value="7" data-mode="follows" class="btn-input btn-pad-number">7</button>
                    <button data-value="8" data-mode="follows" class="btn-input btn-pad-number">8</button>
                    <button data-value="9" data-mode="follows" class="btn-input btn-pad-number">9</button>
                </div>
                <div class="grid grid-cols-4 gap-3">
                    <button data-action="play-demo" data-mode="follows" class="btn-input btn-control !bg-primary-app hover:!bg-secondary-app text-2xl">‚ñ∂</button>
                    <button data-action="voice-input" data-mode="follows" class="btn-input btn-control !bg-primary-app hover:!bg-secondary-app text-2xl hidden" title="Voice Input">üé§</button>
                    <button id="backspace-button-follows" data-action="backspace" data-mode="follows" class="btn-input btn-control text-2xl">&larr;</button>
                    <button data-action="open-settings" data-mode="follows" class="btn-input btn-control !bg-primary-app hover:!bg-secondary-app text-2xl">‚öôÔ∏è</button>
                </div>
            </div>

            <div id="piano-pad" class="max-w-xl mx-auto pt-0 pb-4" style="display: none;">
                <div id="piano-keys" class="relative h-48 w-full bg-gray-200 rounded-md shadow-inner overflow-hidden mb-4">
                    <div class="flex h-full w-full">
                        <div class="key-container"><button data-value="C" data-mode="piano" class="piano-key-white btn-input">C</button></div>
                        <div class="key-container"><button data-value="D" data-mode="piano" class="piano-key-white btn-input">D</button></div>
                        <div class="key-container"><button data-value="E" data-mode="piano" class="piano-key-white btn-input">E</button></div>
                        <div class="key-container"><button data-value="F" data-mode="piano" class="piano-key-white btn-input">F</button></div>
                        <div class="key-container"><button data-value="G" data-mode="piano" class="piano-key-white btn-input">G</button></div>
                        <div class="key-container"><button data-value="A" data-mode="piano" class="piano-key-white btn-input">A</button></div>
                        <div class="key-container"><button data-value="B" data-mode="piano" class="piano-key-white btn-input">B</button></div>
                    </div>
                    <button data-value="1" data-mode="piano" class="piano-key-black btn-input black-1">1</button>
                    <button data-value="2" data-mode="piano" class="piano-key-black btn-input black-2">2</button>
                    <button data-value="3" data-mode="piano" class="piano-key-black btn-input black-3">3</button>
                    <button data-value="4" data-mode="piano" class="piano-key-black btn-input black-4">4</button>
                    <button data-value="5" data-mode="piano" class="piano-key-black btn-input black-5">5</button>
                </div>
                <div class="grid grid-cols-4 gap-3 max-w-xs mx-auto">
                    <button data-action="demo" data-mode="piano" class="btn-input btn-control !bg-primary-app hover:!bg-secondary-app text-2xl">‚ñ∂</button>
                    <button data-action="voice-input" data-mode="piano" class="btn-input btn-control !bg-primary-app hover:!bg-secondary-app text-2xl hidden" title="Voice Input">üé§</button>
                    <button id="backspace-button-piano" data-action="backspace" data-mode="piano" class="btn-input btn-control text-2xl">&larr;</button>
                    <button data-action="open-settings" data-mode="piano" class="btn-input btn-control !bg-primary-app hover:!bg-secondary-app text-2xl">‚öôÔ∏è</button>
                </div>
            </div>

            <div id="rounds15-pad" class="max-w-md mx-auto" style="display: none;">
                <div class="grid grid-cols-4 gap-3 mb-3">
                    <button data-value="1" data-mode="rounds15" class="btn-input btn-pad-number">1</button>
                    <button data-value="2" data-mode="rounds15" class="btn-input btn-pad-number">2</button>
                    <button data-value="3" data-mode="rounds15" class="btn-input btn-pad-number">3</button>
                    <button data-value="4" data-mode="rounds15" class="btn-input btn-pad-number">4</button>
                    <button data-value="5" data-mode="rounds15" class="btn-input btn-pad-number">5</button>
                    <button data-value="6" data-mode="rounds15" class="btn-input btn-pad-number">6</button>
                    <button data-value="7" data-mode="rounds15" class="btn-input btn-pad-number">7</button>
                    <button data-value="8" data-mode="rounds15" class="btn-input btn-pad-number">8</button>
                    <button data-value="9" data-mode="rounds15" class="btn-input btn-pad-number">9</button>
                    <button data-value="10" data-mode="rounds15" class="btn-input btn-pad-number">10</button>
                    <button data-value="11" data-mode="rounds15" class="btn-input btn-pad-number">11</button>
                    <button data-value="12" data-mode="rounds15" class="btn-input btn-pad-number">12</button>
                </div>
                <div class="grid grid-cols-5 gap-3">
                    <button data-action="demo" data-mode="rounds15" class="btn-input btn-control !bg-primary-app hover:!bg-secondary-app text-white font-bold rounded-xl text-2xl">‚ñ∂</button>

                    <button id="rounds15-reset" data-action="reset-rounds" data-mode="rounds15" class="btn-input btn-control !bg-btn-control-red hover:!bg-btn-control-red-active text-white font-bold rounded-xl text-xl">
                        RESET
                    </button> 
                    <button data-action="voice-input" data-mode="rounds15" class="btn-input btn-control !bg-primary-app hover:!bg-secondary-app text-2xl hidden" title="Voice Input">üé§</button>
                    <button id="backspace-button-rounds15" data-action="backspace" data-mode="rounds15" class="btn-input btn-control text-2xl">&larr;</button>
                    <button data-action="open-settings" data-mode="rounds15" class="btn-input btn-control !bg-primary-app hover:!bg-secondary-app text-2xl">‚öôÔ∏è</button>
                </div>
            </div>
            
        </footer>
    </div>

    <div id="virtual-assistant-prompts" class="hidden">
        <h4 class="text-primary-app">Virtual Assistant Prompts</h4>
        <p>Use these prompts with a voice assistant to manage the game modes hands-free. Click the üìã button to copy the full prompt to your clipboard.</p>
        
        <label for="prompt-bananas" class="font-bold text-gray-900 dark:text-white">Bananas Prompt</label>
        <textarea id="prompt-bananas" class="prompt-box" readonly>Let's play 'Bananas'. This is fully automatic.
1. I will give you one number at a time.
2. After each number I say, you will **immediately** read the **entire** sequence, including the new number, back to me.
3. After you finish speaking, I will give you the next number.
4. 'Clear': Delete the last number.
5. 'Clear all': Delete the entire sequence.
Let's start.</textarea>
        <button class="copy-button" data-copy-target="prompt-bananas">üìã <span class="ml-2">Copy</span></button>

        <label for="prompt-piano" class="font-bold text-gray-900 dark:text-white">Piano Prompt</label>
        <textarea id="prompt-piano" class="prompt-box" readonly>Let's play 'Piano'. This is fully automatic.
1. I will give you one note at a time (e.g., C, 1, G, 4).
2. After each note I say, you will **immediately** read the **entire** sequence, including the new note, back to me.
3. After you finish speaking, I will give you the next note.
4. 'Clear': Delete the last note.
5. 'Clear all': Delete the entire sequence.
Let's start.</textarea>
        <button class="copy-button" data-copy-target="prompt-piano">üìã <span class="ml-2">Copy</span></button>

        <label for="prompt-follows-2" class="font-bold text-gray-900 dark:text-white">Follows (2 Sequences) Prompt</label>
        <textarea id="prompt-follows-2" class="prompt-box" readonly>Let's play 'Follows' with 2 sequences. This is fully automatic.
1. I will give you numbers one by one. Silently assign them in a cycle:
- 1st to Seq 1
- 2nd to Seq 2
- 3rd to Seq 1
- 4th to Seq 2... and so on.
2. As soon as I give you a number for Sequence 2, you will **immediately** read all sequences back to me in chunks of 3. (e.g., 3 from S1, 3 from S2... then next 3 from S1, etc.)
3. After you finish speaking, I will give you the next number for Sequence 1.
4. 'Clear' deletes the last number. 'Clear all' deletes everything.
Let's start.</textarea>
        <button class="copy-button" data-copy-target="prompt-follows-2">üìã <span class="ml-2">Copy</span></button>
        
        <label for="prompt-follows-3" class="font-bold text-gray-900 dark:text-white">Follows (3 Sequences) Prompt</label>
        <textarea id="prompt-follows-3" class="prompt-box" readonly>Let's play 'Follows' with 3 sequences. This is fully automatic.
1. I will give you numbers one by one. Silently assign them in a cycle:
- 1st to Seq 1
- 2nd to Seq 2
- 3rd to Seq 3
- 4th to Seq 1... and so on.
2. As soon as I give you a number for Sequence 3, you will **immediately** read all sequences back to me in chunks of 3. (e.g., 3 from S1, 3 from S2, 3 from S3... then next 3 from S1, etc.)
3. After you finish speaking, I will give you the next number for Sequence 1.
4. 'Clear' deletes the last number. 'Clear all' deletes everything.
Let's start.</textarea>
        <button class="copy-button" data-copy-target="prompt-follows-3">üìã <span class="ml-2">Copy</span></button>
        
        <label for="prompt-follows-4" class="font-bold text-gray-900 dark:text-white">Follows (4 Sequences) Prompt</label>
        <textarea id="prompt-follows-4" class="prompt-box" readonly>Let's play 'Follows' with 4 sequences. This is fully automatic.
1. I will give you numbers one by one. Silently assign them in a cycle:
- 1st to Seq 1
- 2nd to Seq 2
- 3rd to Seq 3
- 4th to Seq 4
- 5th to Seq 1... and so on.
2. As soon as I give you a number for Sequence 4, you will **immediately** read all sequences back to me in chunks of 3. (e.g., 3 from S1, 3 from S2, 3 from S3, 3 from S4... then next 3 from S1, etc.)
3. After you finish speaking, I will give you the next number for Sequence 1.
4. 'Clear' deletes the last number. 'Clear all' deletes everything.
Let's start.</textarea>
        <button class="copy-button" data-copy-target="prompt-follows-4">üìã <span class="ml-2">Copy</span></button>
        
        <label for="prompt-rounds15" class="font-bold text-gray-900 dark:text-white">15 rounds Prompt</label>
        <textarea id="prompt-rounds15" class="prompt-box" readonly>Let's play '15 rounds'. This is fully automatic.
1. We start at Round 1 (1 number) and go to Round 15 (15 numbers).
2. I will give you the numbers for the current round, one at a time. Silently store them.
3. As soon as I give you the **last number for that round** (e.g., the 3rd number in Round 3), you will **immediately** read the full sequence for that round back to me.
4. After you finish reading, you will **immediately** clear the sequence, advance to the next round, and say "Next Round" to let me know you are ready.
5. 'Repeat': Read the current round's sequence again.
6. 'Reset': Go back to Round 1.
Let's start with Round 1.</textarea>
        <button class="copy-button" data-copy-target="prompt-rounds15">üìã <span class="ml-2">Copy</span></button>
    </div>
    <script src="app.js" defer></script>

</body>
</html>
hidden mb-4">
                    <div class="flex h-full w-full">
                        <div class="key-container"><button data-value="C" data-mode="piano" class="piano-key-white btn-input">C</button></div>
                        <div class="key-container"><button data-value="D" data-mode="piano" class="piano-key-white btn-input">D</button></div>
                        <div class="key-container"><button data-value="E" data-mode="piano" class="piano-key-white btn-input">E</button></div>
                        <div class="key-container"><button data-value="F" data-mode="piano" class="piano-key-white btn-input">F</button></div>
                        <div class="key-container"><button data-value="G" data-mode="piano" class="piano-key-white btn-input">G</button></div>
                        <div class="key-container"><button data-value="A" data-mode="piano" class="piano-key-white btn-input">A</button></div>
                        <div class="key-container"><button data-value="B" data-mode="piano" class="piano-key-white btn-input">B</button></div>
                    </div>
                    <button data-value="1" data-mode="piano" class="piano-key-black btn-input black-1">1</button>
                    <button data-value="2" data-mode="piano" class="piano-key-black btn-input black-2">2</button>
                    <button data-value="3" data-mode="piano" class="piano-key-black btn-input black-3">3</button>
                    <button data-value="4" data-mode="piano" class="piano-key-black btn-input black-4">4</button>
                    <button data-value="5" data-mode="piano" class="piano-key-black btn-input black-5">5</button>
                </div>
                <div class="grid grid-cols-4 gap-3 max-w-xs mx-auto">
                    <button data-action="demo" data-mode="piano" class="btn-input btn-control !bg-primary-app hover:!bg-secondary-app text-2xl">‚ñ∂</button>
                    <button data-action="voice-input" data-mode="piano" class="btn-input btn-control !bg-primary-app hover:!bg-secondary-app text-2xl hidden" title="Voice Input">üé§</button>
                    <button id="backspace-button-piano" data-action="backspace" data-mode="piano" class="btn-input btn-control text-2xl">&larr;</button>
                    <button data-action="open-settings" data-mode="piano" class="btn-input btn-control !bg-primary-app hover:!bg-secondary-app text-2xl">‚öôÔ∏è</button>
                </div>
            </div>

            <div id="rounds15-pad" class="max-w-md mx-auto" style="display: none;">
                <div class="grid grid-cols-4 gap-3 mb-3">
                    <button data-value="1" data-mode="rounds15" class="btn-input btn-pad-number">1</button>
                    <button data-value="2" data-mode="rounds15" class="btn-input btn-pad-number">2</button>
                    <button data-value="3" data-mode="rounds15" class="btn-input btn-pad-number">3</button>
                    <button data-value="4" data-mode="rounds15" class="btn-input btn-pad-number">4</button>
                    <button data-value="5" data-mode="rounds15" class="btn-input btn-pad-number">5</button>
                    <button data-value="6" data-mode="rounds15" class="btn-input btn-pad-number">6</button>
                    <button data-value="7" data-mode="rounds15" class="btn-input btn-pad-number">7</button>
                    <button data-value="8" data-mode="rounds15" class="btn-input btn-pad-number">8</button>
                    <button data-value="9" data-mode="rounds15" class="btn-input btn-pad-number">9</button>
                    <button data-value="10" data-mode="rounds15" class="btn-input btn-pad-number">10</button>
                    <button data-value="11" data-mode="rounds15" class="btn-input btn-pad-number">11</button>
                    <button data-value="12" data-mode="rounds15" class="btn-input btn-pad-number">12</button>
                </div>
                <div class="grid grid-cols-5 gap-3">
                    <button data-action="demo" data-mode="rounds15" class="btn-input btn-control !bg-primary-app hover:!bg-secondary-app text-white font-bold rounded-xl text-2xl">‚ñ∂</button>

                    <button id="rounds15-reset" data-action="reset-rounds" data-mode="rounds15" class="btn-input btn-control !bg-btn-control-red hover:!bg-btn-control-red-active text-white font-bold rounded-xl text-xl">
                        RESET
                    </button> 
                    <button data-action="voice-input" data-mode="rounds15" class="btn-input btn-control !bg-primary-app hover:!bg-secondary-app text-2xl hidden" title="Voice Input">üé§</button>
                    <button id="backspace-button-rounds15" data-action="backspace" data-mode="rounds15" class="btn-input btn-control text-2xl">&larr;</button>
                    <button data-action="open-settings" data-mode="rounds15" class="btn-input btn-control !bg-primary-app hover:!bg-secondary-app text-2xl">‚öôÔ∏è</button>
                </div>
            </div>
            
        </footer>
    </div>

    <!-- Virtual Assistant Prompts (hidden, used by Help Modal) -->
    <div id="virtual-assistant-prompts" class="hidden">
        <h4 class="text-primary-app">Virtual Assistant Prompts</h4>
        <p>Use these prompts with a voice assistant to manage the game modes hands-free. Click the üìã button to copy the full prompt to your clipboard.</p>
        
        <label for="prompt-bananas" class="font-bold text-gray-900 dark:text-white">Bananas Prompt</label>
        <textarea id="prompt-bananas" class="prompt-box" readonly>Let's play 'Bananas'. This is fully automatic.
1. I will give you one number at a time.
2. After each number I say, you will **immediately** read the **entire** sequence, including the new number, back to me.
3. After you finish speaking, I will give you the next number.
4. 'Clear': Delete the last number.
5. 'Clear all': Delete the entire sequence.
Let's start.</textarea>
        <button class="copy-button" data-copy-target="prompt-bananas">üìã <span class="ml-2">Copy</span></button>

        <label for="prompt-piano" class="font-bold text-gray-900 dark:text-white">Piano Prompt</label>
        <textarea id="prompt-piano" class="prompt-box" readonly>Let's play 'Piano'. This is fully automatic.
1. I will give you one note at a time (e.g., C, 1, G, 4).
2. After each note I say, you will **immediately** read the **entire** sequence, including the new note, back to me.
3. After you finish speaking, I will give you the next note.
4. 'Clear': Delete the last note.
5. 'Clear all': Delete the entire sequence.
Let's start.</textarea>
        <button class="copy-button" data-copy-target="prompt-piano">üìã <span class="ml-2">Copy</span></button>

        <label for="prompt-follows-2" class="font-bold text-gray-900 dark:text-white">Follows (2 Sequences) Prompt</label>
        <textarea id="prompt-follows-2" class="prompt-box" readonly>Let's play 'Follows' with 2 sequences. This is fully automatic.
1. I will give you numbers one by one. Silently assign them in a cycle:
- 1st to Seq 1
- 2nd to Seq 2
- 3rd to Seq 1
- 4th to Seq 2... and so on.
2. As soon as I give you a number for Sequence 2, you will **immediately** read all sequences back to me in chunks of 3. (e.g., 3 from S1, 3 from S2... then next 3 from S1, etc.)
3. After you finish speaking, I will give you the next number for Sequence 1.
4. 'Clear' deletes the last number. 'Clear all' deletes everything.
Let's start.</textarea>
        <button class="copy-button" data-copy-target="prompt-follows-2">üìã <span class="ml-2">Copy</span></button>
        
        <label for="prompt-follows-3" class="font-bold text-gray-900 dark:text-white">Follows (3 Sequences) Prompt</label>
        <textarea id="prompt-follows-3" class="prompt-box" readonly>Let's play 'Follows' with 3 sequences. This is fully automatic.
1. I will give you numbers one by one. Silently assign them in a cycle:
- 1st to Seq 1
- 2nd to Seq 2
- 3rd to Seq 3
- 4th to Seq 1... and so on.
2. As soon as I give you a number for Sequence 3, you will **immediately** read all sequences back to me in chunks of 3. (e.g., 3 from S1, 3 from S2, 3 from S3... then next 3 from S1, etc.)
3. After you finish speaking, I will give you the next number for Sequence 1.
4. 'Clear' deletes the last number. 'Clear all' deletes everything.
Let's start.</textarea>
        <button class="copy-button" data-copy-target="prompt-follows-3">üìã <span class="ml-2">Copy</span></button>
        
        <label for="prompt-follows-4" class="font-bold text-gray-900 dark:text-white">Follows (4 Sequences) Prompt</label>
        <textarea id="prompt-follows-4" class="prompt-box" readonly>Let's play 'Follows' with 4 sequences. This is fully automatic.
1. I will give you numbers one by one. Silently assign them in a cycle:
- 1st to Seq 1
- 2nd to Seq 2
- 3rd to Seq 3
- 4th to Seq 4
- 5th to Seq 1... and so on.
2. As soon as I give you a number for Sequence 4, you will **immediately** read all sequences back to me in chunks of 3. (e.g., 3 from S1, 3 from S2, 3 from S3, 3 from S4... then next 3 from S1, etc.)
3. After you finish speaking, I will give you the next number for Sequence 1.
4. 'Clear' deletes the last number. 'Clear all' deletes everything.
Let's start.</textarea>
        <button class="copy-button" data-copy-target="prompt-follows-4">üìã <span class="ml-2">Copy</span></button>
        
        <label for="prompt-rounds15" class="font-bold text-gray-900 dark:text-white">15 rounds Prompt</label>
        <textarea id="prompt-rounds15" class="prompt-box" readonly>Let's play '15 rounds'. This is fully automatic.
1. We start at Round 1 (1 number) and go to Round 15 (15 numbers).
2. I will give you the numbers for the current round, one at a time. Silently store them.
3. As soon as I give you the **last number for that round** (e.g., the 3rd number in Round 3), you will **immediately** read the full sequence for that round back to me.
4. After you finish reading, you will **immediately** clear the sequence, advance to the next round, and say "Next Round" to let me know you are ready.
5. 'Repeat': Read the current round's sequence again.
6. 'Reset': Go back to Round 1.
Let's start with Round 1.</textarea>
        <button class="copy-button" data-copy-target="prompt-rounds15">üìã <span class="ml-2">Copy</span></button>
    </div>
    <!-- End Virtual Assistant Prompts -->


    <script>
        (function () {
        
            // --- Application State and Constants ---
            const MAX_SEQUENCES = 4;
            const DEMO_DELAY_BASE_MS = 798;
            const SPEED_DELETE_INITIAL_DELAY = 250;
            const SPEED_DELETE_INTERVAL_MS = 10;    
            
            let initialDelayTimer = null; 
            let speedDeleteInterval = null; 

            // Mode Definitions
            const MODES = ['bananas', 'follows', 'piano', 'rounds15']; 
            const MODE_LABELS = {
                'bananas': 'Bananas',
                'follows': 'follows',
                'piano': 'piano',
                'rounds15': '15 rounds',
            };
            
            // Piano mapping for speech
            const PIANO_SPEAK_MAP = {
                'C': 'C', 'D': 'D', 'E': 'E', 'F': 'F', 'G': 'G', 'A': 'A', 'B': 'B',
                '1': '1', '2': '2', '3': '3', '4': '4', '5': '5'
            };
            
            // Settings State (All toggles ON by default)
            let settings = {
                isDarkMode: true,
                bananasSpeedMultiplier: 1.0, // Used for Bananas and Follows
                pianoSpeedMultiplier: 1.0, 
                rounds15SpeedMultiplier: 1.0,
                uiScaleMultiplier: 1.0, 
                isSpeedDeletingEnabled: true, 
                isPianoAutoplayEnabled: true, 
                isBananasAutoplayEnabled: true, 
                isFollowsAutoplayEnabled: true, 
                isRounds15ClearAfterPlaybackEnabled: true, 
                isAudioPlaybackEnabled: true,
                isVoiceInputEnabled: true, // NEW
                areSlidersLocked: true,
                followsChunkSize: 3, 
            };

            // --- Data Store ---
            let appState = {
                'bananas': getInitialState('bananas'),
                'follows': getInitialState('follows'),
                'piano': getInitialState('piano'), 
                'rounds15': getInitialState('rounds15'),
            };
            
            let currentMode = 'bananas'; 
            
            const getCurrentState = () => appState[currentMode];

            
            // --- DOM Elements ---
            const sequenceContainer = document.getElementById('sequence-container');
            const customModal = document.getElementById('custom-modal');

            // Settings Modal Elements
            const settingsModal = document.getElementById('settings-modal');
            const settingsModeToggleButton = document.getElementById('settings-mode-toggle-button');
            const settingsModeDropdown = document.getElementById('settings-mode-dropdown');
            const openHelpButton = document.getElementById('open-help-button'); 
            const followsCountSelect = document.getElementById('follows-count-select'); 
            const followsChunkSizeSelect = document.getElementById('follows-chunk-size-select'); 

            // Help Modal Elements
            const helpModal = document.getElementById('help-modal');
            const helpContent = document.getElementById('help-content');
            
            // Toggles
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const speedDeleteToggle = document.getElementById('speed-delete-toggle'); 
            const pianoAutoplayToggle = document.getElementById('piano-autoplay-toggle'); 
            const bananasAutoplayToggle = document.getElementById('bananas-autoplay-toggle'); 
            const followsAutoplayToggle = document.getElementById('follows-autoplay-toggle'); 
            const rounds15ClearAfterPlaybackToggle = document.getElementById('rounds15-clear-after-playback-toggle');
            const audioPlaybackToggle = document.getElementById('audio-playback-toggle'); 
            const voiceInputToggle = document.getElementById('voice-input-toggle'); // NEW
            const sliderLockToggle = document.getElementById('slider-lock-toggle'); 

            // Sliders and Displays
            const bananasSpeedSlider = document.getElementById('bananas-speed-slider');
            const bananasSpeedDisplay = document.getElementById('bananas-speed-display');
            const pianoSpeedSlider = document.getElementById('piano-speed-slider');
            const pianoSpeedDisplay = document.getElementById('piano-speed-display');
            const rounds15SpeedSlider = document.getElementById('rounds15-speed-slider');
            const rounds15SpeedDisplay = document.getElementById('rounds15-speed-display');
            const uiScaleSlider = document.getElementById('ui-scale-slider');
            const uiScaleDisplay = document.getElementById('ui-scale-display');
            
            // Pad Elements
            const bananasPad = document.getElementById('bananas-pad');
            const followsPad = document.getElementById('follows-pad');
            const pianoPad = document.getElementById('piano-pad');
            const rounds15Pad = document.getElementById('rounds15-pad');
            const allMicButtons = document.querySelectorAll('button[data-action="voice-input"]'); // NEW

            // --- NEW: Speech Recognition ---
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognitionApi = SpeechRecognition ? new SpeechRecognition() : null;
            let isListening = false;

            // Voice Command Mapping
            const VOICE_COMMAND_MAP = {
                'one': '1', 'two': '2', 'to': '2', 'three': '3', 'four': '4', 'for': '4', 'five': '5',
                'six': '6', 'seven': '7', 'eight': '8', 'nine': '9', 'ten': '10',
                'eleven': '11', 'twelve': '12',
                'see': 'C', 'dee': 'D', 'e': 'E', 'eff': 'F', 'gee': 'G', 'eh': 'A', 'be': 'B',
                'c': 'C', 'd': 'D', 'f': 'F', 'g': 'G', 'a': 'A', 'b': 'B',
                'clear': 'BACKSPACE', 'delete': 'BACKSPACE', 'back': 'BACKSPACE',
                'reset': 'RESET',
            };

            // --- Core Functions for State Management ---

            /**
             * Creates an initial state object for a given mode.
             */
            function getInitialState(mode) {
                switch (mode) {
                    case 'follows':
                        return { 
                            sequences: Array.from({ length: MAX_SEQUENCES }, () => []),
                            sequenceCount: 2, // Default
                            nextSequenceIndex: 0
                        };
                    case 'rounds15': 
                        return {
                            sequences: [[]], 
                            sequenceCount: 1, 
                            nextSequenceIndex: 0,
                            currentRound: 1,
                            maxRound: 15
                        };
                    case 'bananas':
                    case 'piano':
                    default:
                        return { 
                            sequences: [[]], 
                            sequenceCount: 1, 
                            nextSequenceIndex: 0 
                        };
                }
            }

            /**
             * Renders the current state's sequences to the DOM.
             */
            function renderSequences() {
                const state = getCurrentState();
                const { sequences, sequenceCount } = state;
                const activeSequences = sequences.slice(0, sequenceCount);
                sequenceContainer.innerHTML = '';
                
                const currentTurnIndex = state.nextSequenceIndex % sequenceCount;

                // 1. Set Layout Classes for the main container
                let layoutClasses = 'gap-4 flex-grow mb-6 transition-all duration-300 pt-1 ';

                if (currentMode === 'bananas') {
                    layoutClasses += ' flex flex-col max-w-xl mx-auto';
                } else if (currentMode === 'follows') {
                    if (sequenceCount === 2) {
                        layoutClasses += ' grid grid-cols-2 max-w-3xl mx-auto';
                    } else if (sequenceCount === 3) {
                        layoutClasses += ' grid grid-cols-3 max-w-4xl mx-auto';
                    } else if (sequenceCount === 4) {
                        layoutClasses += ' grid grid-cols-4 max-w-5xl mx-auto';
                    }
                } else if (currentMode === 'piano' || currentMode === 'rounds15') {
                    layoutClasses += ' flex flex-col max-w-2xl mx-auto';
                }
                sequenceContainer.className = layoutClasses;

                // 2. Add Round Display for '15 rounds' mode
                if (currentMode === 'rounds15') {
                    const roundDisplay = document.createElement('div');
                    roundDisplay.className = 'text-center text-2xl font-bold mb-4 text-gray-900 dark:text-gray-100';
                    roundDisplay.id = 'rounds15-round-display';
                    roundDisplay.textContent = `Round: ${state.currentRound} / ${state.maxRound}`;
                    sequenceContainer.appendChild(roundDisplay);
                }

                // 3. Determine grid columns for sequence items
                let numColumns = 0;
                if (currentMode === 'bananas') numColumns = 5;
                else if (currentMode === 'follows') {
                    if (sequenceCount === 2) numColumns = 4;
                    else if (sequenceCount === 3) numColumns = 4;
                    else if (sequenceCount === 4) numColumns = 3; 
                } else if (currentMode === 'piano' || currentMode === 'rounds15') numColumns = 5; 
                
                let gridClass = numColumns > 0 ? `grid grid-cols-${numColumns}` : 'flex flex-wrap';
                
                // 4. Calculate UI Scale
                const baseSize = 40;
                const baseFont = 1.1;
                const newSize = baseSize * settings.uiScaleMultiplier;
                const newFont = baseFont * settings.uiScaleMultiplier;
                const sizeStyle = `height: ${newSize}px; line-height: ${newSize}px; font-size: ${newFont}rem;`;

                // 5. Render each active sequence
                activeSequences.forEach((set, index) => {
                    const isCurrent = currentTurnIndex === index;
                    const sequenceDiv = document.createElement('div');
                    
                    const originalClasses = `p-4 rounded-xl shadow-md transition-all duration-200 ${isCurrent ? 'bg-accent-app scale-[1.02] shadow-lg text-gray-900' : 'bg-white dark:bg-gray-700 shadow-sm text-gray-900 dark:text-gray-100'}`;
                    sequenceDiv.className = originalClasses;
                    sequenceDiv.dataset.originalClasses = originalClasses; // Store for restore
                    
                    sequenceDiv.innerHTML = `
                        <div class="${gridClass} gap-2 min-h-[50px]"> 
                            ${set.map(val => `
                                <span class="number-box bg-secondary-app text-white rounded-xl text-center shadow-sm"
                                      style="${sizeStyle}">
                                    ${val}
                                </span>
                            `).join('')}
                        </div>
                    `;
                    sequenceContainer.appendChild(sequenceDiv);
                });
            }

            /**
             * Adds a new value to the appropriate sequence.
             */
            function addValue(value) {
                const state = getCurrentState();
                const { sequences, sequenceCount } = state;
                
                if (sequenceCount === 0) return;

                // Check length constraints
                if (currentMode === 'rounds15' && sequences[0].length >= state.currentRound) {
                    return; 
                }
                if (currentMode === 'bananas' && sequences[0].length >= 25) return;
                if (currentMode === 'follows' && sequences[state.nextSequenceIndex % sequenceCount].length >= 25) return;
                // --- MODIFICATION: Changed 2 to 20 ---
                if (currentMode === 'piano' && sequences[0].length >= 20) return; 

                // Add value
                const targetIndex = state.nextSequenceIndex % sequenceCount;
                sequences[targetIndex].push(value);
                state.nextSequenceIndex++;
                
                const justFilledIndex = (state.nextSequenceIndex - 1) % sequenceCount;

                renderSequences();
                
                // --- Autoplay Logic ---
                if (currentMode === 'piano' && settings.isPianoAutoplayEnabled) { 
                    setTimeout(() => { handlePianoDemo(); }, 100); 
                }
                else if (currentMode === 'bananas' && settings.isBananasAutoplayEnabled) {
                    setTimeout(() => { handleBananasDemo(); }, 100); 
                }
                else if (currentMode === 'follows' && settings.isFollowsAutoplayEnabled) {
                    // Only autoplay 'follows' after filling the *last* sequence
                    if (justFilledIndex === state.sequenceCount - 1) {
                         setTimeout(() => { handleFollowsDemo(); }, 100);
                    }
                }
                else if (currentMode === 'rounds15') {
                    // Autoplay '15 rounds' when the round is full
                    const sequence = state.sequences[0];
                    if (sequence.length === state.currentRound) {
                        // Disable input keys, but not control keys
                        const allKeys = document.querySelectorAll('#rounds15-pad button[data-value]');
                        allKeys.forEach(key => key.disabled = true);
                        
                        setTimeout(() => { handleRounds15Demo(); }, 100); 
                    }
                }
            }
            
            /**
             * Removes the last added value from the sequences.
             */
            function handleBackspace() {
                const state = getCurrentState();
                const { sequences, sequenceCount } = state;
                
                // Prevent backspace while a demo is running
                if (currentMode === 'rounds15') {
                    const demoButton = document.querySelector('#rounds15-pad button[data-action="demo"]');
                    if (demoButton && demoButton.disabled) return;
                }
                if (currentMode === 'follows') {
                    const demoButton = document.querySelector('#follows-pad button[data-action="play-demo"]');
                    if (demoButton && demoButton.disabled) return;
                }

                if (state.nextSequenceIndex === 0) return; 
                
                const lastClickTargetIndex = (state.nextSequenceIndex - 1) % sequenceCount;
                const targetSet = sequences[lastClickTargetIndex];
                
                if (targetSet.length > 0) {
                    targetSet.pop();
                    state.nextSequenceIndex--; 

                    // Re-enable 15-rounds keys if we delete back
                    if (currentMode === 'rounds15') {
                         const allKeys = document.querySelectorAll('#rounds15-pad button[data-value]');
                         allKeys.forEach(key => key.disabled = false);
                    }

                    renderSequences();
                }
            }


            // --- Backspace Speed Deleting Logic ---
            
            function stopSpeedDeleting() {
                if (initialDelayTimer) clearTimeout(initialDelayTimer);
                if (speedDeleteInterval) clearInterval(speedDeleteInterval);
                initialDelayTimer = null;
                speedDeleteInterval = null;
            }

            function handleBackspaceStart(event) {
                event.preventDefault(); 
                stopSpeedDeleting(); 

                // 1. Handle single click (will be triggered on 'end' if timer is short)
                // 2. Check if speed deleting is enabled
                if (!settings.isSpeedDeletingEnabled) return;
                
                // 3. Check if demos are running (which disable backspace)
                if (currentMode === 'rounds15') {
                    const demoButton = document.querySelector('#rounds15-pad button[data-action="demo"]');
                    if (demoButton && demoButton.disabled) return;
                }
                if (currentMode === 'follows') {
                    const demoButton = document.querySelector('#follows-pad button[data-action="play-demo"]');
                    if (demoButton && demoButton.disabled) return;
                }

                // 4. Start the speed delete timers
                initialDelayTimer = setTimeout(() => {
                    handleBackspace(); // Delete one immediately
                    speedDeleteInterval = setInterval(handleBackspace, SPEED_DELETE_INTERVAL_MS);
                    initialDelayTimer = null; // Mark initial delay as passed
                }, SPEED_DELETE_INITIAL_DELAY);
            }

            function handleBackspaceEnd() {
                if (initialDelayTimer !== null) {
                    // Timer was set, but didn't fire (short click)
                    stopSpeedDeleting();
                    handleBackspace(); // Manually trigger the single backspace
                } 
                else if (!settings.isSpeedDeletingEnabled) {
                    // Speed deleting is off, trigger single click
                    handleBackspace();
                } 
                else {
                    // Timer fired (long press), just stop the interval
                    stopSpeedDeleting();
                }
            }

            // --- Settings Panel Logic ---

            function renderModeDropdown() {
                settingsModeDropdown.innerHTML = MODES.map(modeKey => `
                    <button data-mode-select="${modeKey}" 
                            class="w-full text-left px-4 py-3 text-lg font-semibold 
                                ${currentMode === modeKey ? 'bg-primary-app text-white' : 'text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600'} 
                                transition-colors duration-150">
                        ${MODE_LABELS[modeKey]}
                    </button>
                `).join('');
            }

            function toggleModeDropdown(event) {
                event.stopPropagation();
                if (settingsModeDropdown.classList.contains('hidden')) {
                    renderModeDropdown();
                    // Position dropdown relative to the modal
                    const rect = settingsModeToggleButton.getBoundingClientRect();
                    const modalRect = settingsModal.querySelector('div').getBoundingClientRect();
                    settingsModeDropdown.style.position = 'absolute';
                    settingsModeDropdown.style.left = `${rect.left - modalRect.left}px`;
                    settingsModeDropdown.style.width = `${rect.width}px`;
                    settingsModeDropdown.style.top = `${rect.bottom - modalRect.top}px`;
                    
                    settingsModeDropdown.classList.remove('hidden');
                    setTimeout(() => settingsModeDropdown.classList.remove('opacity-0'), 10);
                    // Add listener to close dropdown
                    document.addEventListener('click', closeModeDropdownOnOutsideClick, true);
                } else {
                    closeModeDropdown();
                }
            }

            function closeModeDropdown() {
                settingsModeDropdown.classList.add('opacity-0');
                setTimeout(() => settingsModeDropdown.classList.add('hidden'), 200);
                document.removeEventListener('click', closeModeDropdownOnOutsideClick, true);
            }

            function closeModeDropdownOnOutsideClick(event) {
                // Close if click is outside the toggle button AND the dropdown
                if (!event.target.closest('#settings-mode-toggle-button') && !event.target.closest('#settings-mode-dropdown')) {
                    closeModeDropdown();
                }
            }

            function handleModeSelection(newMode) {
                closeModeDropdown();
                updateMode(newMode);
            }

            function openSettingsModal() {
                // Sync UI elements to the current state
                
                // Sync Mode Button
                settingsModeToggleButton.innerHTML = `
                    ${MODE_LABELS[currentMode]}
                    <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                `;
                
                // Sync "follows" settings
                followsCountSelect.value = appState['follows'].sequenceCount;
                followsChunkSizeSelect.value = settings.followsChunkSize;
                
                // Sync Toggles
                darkModeToggle.checked = settings.isDarkMode;
                speedDeleteToggle.checked = settings.isSpeedDeletingEnabled; 
                pianoAutoplayToggle.checked = settings.isPianoAutoplayEnabled; 
                bananasAutoplayToggle.checked = settings.isBananasAutoplayEnabled;
                followsAutoplayToggle.checked = settings.isFollowsAutoplayEnabled;
                rounds15ClearAfterPlaybackToggle.checked = settings.isRounds15ClearAfterPlaybackEnabled;
                audioPlaybackToggle.checked = settings.isAudioPlaybackEnabled; 
                voiceInputToggle.checked = settings.isVoiceInputEnabled; // NEW
                sliderLockToggle.checked = settings.areSlidersLocked; 

                // Sync Speed Sliders
                bananasSpeedSlider.value = settings.bananasSpeedMultiplier * 100;
                updateSpeedDisplay(settings.bananasSpeedMultiplier, bananasSpeedDisplay);
                pianoSpeedSlider.value = settings.pianoSpeedMultiplier * 100;
                updateSpeedDisplay(settings.pianoSpeedMultiplier, pianoSpeedDisplay);
                rounds15SpeedSlider.value = settings.rounds15SpeedMultiplier * 100;
                updateSpeedDisplay(settings.rounds15SpeedMultiplier, rounds15SpeedDisplay);
                
                // Sync UI Scale Slider
                uiScaleSlider.value = settings.uiScaleMultiplier * 100;
                updateScaleDisplay(settings.uiScaleMultiplier, uiScaleDisplay);
                
                updateSliderLockState();
                
                // Show modal
                settingsModal.classList.remove('opacity-0', 'pointer-events-none');
                settingsModal.querySelector('div').classList.remove('scale-90');
            }

            function closeSettingsModal() {
                settingsModal.querySelector('div').classList.add('scale-90');
                settingsModal.classList.add('opacity-0');
                setTimeout(() => settingsModal.classList.add('pointer-events-none'), 300);
            }
            
            // --- Help Modal Logic ---

            function generateHelpContent() {
                // Main help content (before prompts)
                return `
                    <h4 class="text-primary-app">App Overview</h4>
                    <p>This is a multi-mode number/sequence tracker designed to help you practice memorization and pattern recognition. Use the Settings menu (‚öôÔ∏è) to switch between four distinct modes.</p>

                    <h4 class="text-primary-app">1. Bananas</h4>
                    <p>Enter a sequence of numbers (1-9), up to a maximum of 25. When you press the <span class="text-primary-app font-bold">‚ñ∂ Play</span> button, the app flashes the numbers in order on the key-pad, allowing you to visually review the sequence.</p>
                    <ul>
                        <li><span class="font-bold">Input:</span> Numbers 1 through 9.</li>
                        <li><span class="font-bold">Max Length:</span> 25 numbers.</li>
                        <li><span class="font-bold">Demo:</span> Plays back the full sequence.</li>
                        <li><span class="font-bold">Autoplay Option:</span> Plays the demo automatically every time you enter a new number (On by default).</li>
                    </ul>

                    <h4 class="text-primary-app">2. follows</h4>
                    <p>This mode is for tracking multiple sequences (2, 3, or 4), up to 25 numbers each. Each sequence is highlighted in turn as you add numbers.</p>
                    <ul>
                        <li><span class="font-bold">Input:</span> Numbers 1 through 9.</li>
                        <li><span class="font-bold">Demo (‚ñ∂):</span> Plays back all sequences. It plays 'X' numbers from sequence 1, then 'X' from sequence 2, etc., before moving to the next chunk.</li>
                        <li><span class="font-bold">Numbers per sequence:</span> Use the Settings (‚öôÔ∏è) to change 'X' (the chunk size) from 2 to 5. Default is 3.</li>
                        <li><span class="font-bold">Follows Sequences:</span> Use the Settings (‚öôÔ∏è) to select 2, 3, or 4 active sequences.</li>
                        <li><span class="font-bold">Autoplay Option:</span> Plays the demo automatically after you add a number to the *last* sequence (On by default).</li>
                    </ul>
                    
                    <h4 class="text-primary-app">3. piano</h4>
                    <p>Record musical notes (C-B) and sharps (1-5). Use this mode to track or create short musical patterns.</p>
                    <ul>
                        <li><span class="font-bold">Input:</span> White keys (C-B) and black keys (1-5).</li>
                        <li><span class="font-bold">Max Length:</span> 20 notes.</li>
                        <li><span class="font-bold">Demo:</span> Plays back the recorded sequence, flashing the keys as it goes.</li>
                        <li><span class="font-bold">Autoplay Option:</span> Plays the demo automatically every time you enter a new note (On by default).</li>
                    </ul>

                    <h4 class="text-primary-app">4. 15 rounds</h4>
                    <p>This mode guides you through ${appState['rounds15'].maxRound} rounds of increasing sequence length (Round 1 = 1 number, Round 2 = 2 numbers, etc., up to 15).</p>
                    <ul>
                        <li><span class="font-bold">Workflow:</span> Enter the sequence for the current round (e.g., 3 numbers for Round 3).</li>
                        <li><span class="font-bold">Automatic Playback:</span> As soon as you enter the last number for the round, the app will automatically play back the sequence for you.</li>
                        <li><span class="font-bold">Automatic Clear/Advance:</span> After playback, the sequence automatically clears, and the app advances to the next round (On by default).</li>
                        <li><span class="font-bold">Reset:</span> Hit the <span class="font-bold" style="color: ${tailwind.config.theme.extend.colors['btn-control-red']};">RESET</span> button to go back to Round 1.</li>
                    </ul>

                    <h4 class="text-primary-app">Global Features & Settings</h4>
                    <ul>
                        <li><span class="font-bold">Backspace (‚Üê):</span> Removes the last entered value.</li>
                        <li><span class="font-bold">Voice Input (üé§):</span> (If enabled) Click to speak commands like "one", "five", "C", "clear", or "reset".</li>
                        <li><span class="font-bold">Speed Deleting:</span> Hold the backspace key to quickly delete many entries (On by default).</li>
                        <li><span class="font-bold">Audio Playback:</span> Speaks the sequence during demo playback (On by default).</li>
                        <li><span class="font-bold">Playback Speeds:</span> Adjust the speed sliders to control how quickly the demo features execute.</li>
                        <li><span class="font-bold">Sequence Size:</span> Adjust the slider to change the visual size of the number boxes.</li>
                        <li><span class="font-bold">Lock Sliders:</span> Prevents accidental changes to the speed and size sliders (On by default).</li>
                        <li><span class="font-bold">Dark Mode:</span> Toggles the entire app between Dark and Light visual themes (On by default).</li>
                    </ul>
                `;
            }

            function openHelpModal() {
                const helpContentContainer = document.getElementById('help-content');
                
                // 1. Inject the main help text
                helpContentContainer.innerHTML = generateHelpContent();
                
                // 2. Find the hidden prompt section
                const promptSection = document.getElementById('virtual-assistant-prompts');
                if (promptSection) {
                    // 3. Remove the 'hidden' class to make it visible
                    promptSection.classList.remove('hidden');
                    
                    // 4. Move the now-visible section into the modal's content area
                    helpContentContainer.appendChild(promptSection);
                }

                // 5. Show the modal
                helpModal.classList.remove('opacity-0', 'pointer-events-none');
                helpModal.querySelector('div').classList.remove('scale-90');
            }

            function closeHelpModal() {
                const promptSection = document.getElementById('virtual-assistant-prompts');
                
                // When closing, move the prompt section back to the body and hide it
                // This ensures it's available next time the modal opens.
                if (promptSection) {
                    promptSection.classList.add('hidden');
                    document.body.appendChild(promptSection);
                }

                // Hide modal
                helpModal.querySelector('div').classList.add('scale-90');
                helpModal.classList.add('opacity-0');
                setTimeout(() => {
                    helpModal.classList.add('pointer-events-none');
                }, 300);
            }
            
            // --- Theme, Speed, and Scale Control ---

            function updateTheme(isDark) {
                settings.isDarkMode = isDark;
                document.body.classList.toggle('dark', isDark);
                document.body.classList.toggle('light', !isDark);
                renderSequences(); // Re-render to apply correct sequence bg colors
            }
            
            function getSpeedMultiplier(mode) {
                if (mode === 'bananas' || mode === 'follows') return settings.bananasSpeedMultiplier;
                else if (mode === 'piano') return settings.pianoSpeedMultiplier;
                else if (mode === 'rounds15') return settings.rounds15SpeedMultiplier;
                return 1.0; 
            }

            function updateModeSpeed(modeKey, multiplier) {
                settings[`${modeKey}SpeedMultiplier`] = multiplier;
            }

            function updateSpeedDisplay(multiplier, displayElement) {
                const percent = Math.round(multiplier * 100);
                let label = `${percent}%`;
                if (percent === 100) label += ' (Base)';
                else if (percent > 100) label += ' (Fast)';
                else label += ' (Slow)';
                if (displayElement) displayElement.textContent = label;
            }
            
            function updateScaleDisplay(multiplier, displayElement) {
                const percent = Math.round(multiplier * 100);
                let label = `${percent}%`;
                if (percent === 100) label += ' (Base)';
                else if (percent > 100) label += ' (Large)';
                else label += ' (Small)';
                if (displayElement) displayElement.textContent = label;
            }
            
            function updateSliderLockState() {
                const locked = settings.areSlidersLocked;
                if (bananasSpeedSlider) bananasSpeedSlider.disabled = locked;
                if (pianoSpeedSlider) pianoSpeedSlider.disabled = locked;
                if (rounds15SpeedSlider) rounds15SpeedSlider.disabled = locked;
                if (uiScaleSlider) uiScaleSlider.disabled = locked;
            }

            /**
             * Switches the application to a new mode.
             */
            function updateMode(newMode) {
                currentMode = newMode;
                // Toggle pad visibility
                bananasPad.style.display = currentMode === 'bananas' ? 'block' : 'none';
                followsPad.style.display = currentMode === 'follows' ? 'block' : 'none';
                pianoPad.style.display = currentMode === 'piano' ? 'block' : 'none';
                rounds15Pad.style.display = currentMode === 'rounds15' ? 'block' : 'none';
                
                // Update settings modal button if it's open
                if (!settingsModal.classList.contains('pointer-events-none') && settingsModeToggleButton) {
                    settingsModeToggleButton.innerHTML = `
                        ${MODE_LABELS[newMode]}
                        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    `;
                }
                renderSequences();
            }

            // --- NEW: Voice Input Visibility ---
            function updateMicButtonVisibility() {
                const isEnabled = settings.isVoiceInputEnabled;
                allMicButtons.forEach(btn => {
                    btn.classList.toggle('hidden', !isEnabled);
                });
            }
            
            // --- Audio Playback ---
            
            /**
             * Speaks the given text using Web Speech API.
             */
            function speak(text) {
                if (!settings.isAudioPlaybackEnabled || !('speechSynthesis' in window)) return;
                try {
                    window.speechSynthesis.cancel(); // Stop any previous speech
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'en-US'; 
                    utterance.rate = 1.2; 
                    utterance.pitch = 1.0;
                    window.speechSynthesis.speak(utterance);
                } catch (error) {
                    console.error("Speech synthesis failed:", error);
                }
            }
            
            
            // --- Demo Logic ---
            
            function handleBananasDemo() {
                const state = appState['bananas'];
                const sequenceToPlay = state.sequences[0]; 
                const demoButton = document.querySelector('#bananas-pad button[data-action="play-demo"]');
                const inputKeys = document.querySelectorAll('#bananas-pad button[data-value]');
                const speedMultiplier = getSpeedMultiplier('bananas');
                const currentDelayMs = DEMO_DELAY_BASE_MS / speedMultiplier;
                
                if (sequenceToPlay.length === 0 || (demoButton && demoButton.disabled)) {
                    if (demoButton && demoButton.disabled) return; // Demo already running
                    // Only show modal if triggered by user, not autoplay
                    if (!settings.isBananasAutoplayEnabled) {
                        showModal('No Sequence', 'The sequence is empty. Enter some numbers first!', () => closeModal(), 'OK', '');
                    }
                    return;
                }

                // Disable buttons
                demoButton.disabled = true;
                inputKeys.forEach(key => key.disabled = true);
                
                let i = 0;
                const flashDuration = 250 * (speedMultiplier > 1 ? (1/speedMultiplier) : 1); 
                const pauseDuration = currentDelayMs; 

                function playNextNumber() {
                    if (i < sequenceToPlay.length) {
                        const value = sequenceToPlay[i]; 
                        const key = document.querySelector(`#bananas-pad button[data-value="${value}"]`);
                        demoButton.innerHTML = String(i + 1);
                        speak(value);
                        if (key) {
                            key.classList.add('bananas-flash');
                            setTimeout(() => {
                                key.classList.remove('bananas-flash');
                                setTimeout(playNextNumber, pauseDuration - flashDuration);
                            }, flashDuration); 
                        } else {
                            setTimeout(playNextNumber, pauseDuration);
                        }
                        i++;
                    } else {
                        // Re-enable buttons
                        demoButton.disabled = false;
                        demoButton.innerHTML = '‚ñ∂'; 
                        inputKeys.forEach(key => key.disabled = false);
                    }
                }
                playNextNumber();
            }
            
            function handleFollowsDemo() {
                const state = appState['follows'];
                const demoButton = document.querySelector('#follows-pad button[data-action="play-demo"]');
                const inputKeys = document.querySelectorAll('#follows-pad button[data-value]');
                const speedMultiplier = getSpeedMultiplier('follows');
                const currentDelayMs = DEMO_DELAY_BASE_MS / speedMultiplier;
                const chunkSize = settings.followsChunkSize;
                const numSequences = state.sequenceCount;
                const activeSequences = state.sequences.slice(0, numSequences);
                const maxLength = Math.max(...activeSequences.map(s => s.length));
                
                if (maxLength === 0 || (demoButton && demoButton.disabled)) {
                     if (demoButton && demoButton.disabled) return; // Demo already running
                     // Only show modal if triggered by user, not autoplay
                    if (!settings.isFollowsAutoplayEnabled) {
                        showModal('No Sequence', 'The sequences are empty. Enter some numbers first!', () => closeModal(), 'OK', '');
                    }
                    return;
                }
                
                // Build the "playlist"
                const playlist = [];
                const numChunks = Math.ceil(maxLength / chunkSize);

                for (let chunkNum = 0; chunkNum < numChunks; chunkNum++) {
                    for (let seqIndex = 0; seqIndex < numSequences; seqIndex++) {
                        for (let k = 0; k < chunkSize; k++) {
                            const valueIndex = (chunkNum * chunkSize) + k;
                            if (valueIndex < activeSequences[seqIndex].length) {
                                const value = activeSequences[seqIndex][valueIndex];
                                playlist.push({ seqIndex: seqIndex, value: value });
                            }
                        }
                    }
                }
                
                if (playlist.length === 0) return;

                // Disable buttons
                demoButton.disabled = true;
                inputKeys.forEach(key => key.disabled = true);
                
                let i = 0;
                const flashDuration = 250 * (speedMultiplier > 1 ? (1/speedMultiplier) : 1); 
                const pauseDuration = currentDelayMs;

                function playNextItem() {
                    if (i < playlist.length) {
                        const item = playlist[i];
                        const { seqIndex, value } = item;
                        const key = document.querySelector(`#follows-pad button[data-value="${value}"]`);
                        const seqBox = sequenceContainer.children[seqIndex];
                        const originalClasses = seqBox ? seqBox.dataset.originalClasses : '';
                        
                        demoButton.innerHTML = String(i + 1);
                        speak(value);

                        // Flash key and highlight sequence box
                        if (key) key.classList.add('bananas-flash');
                        if (seqBox) seqBox.className = 'p-4 rounded-xl shadow-md transition-all duration-200 bg-accent-app scale-[1.02] shadow-lg text-gray-900';
                        
                        setTimeout(() => {
                            if (key) key.classList.remove('bananas-flash');
                            if (seqBox) seqBox.className = originalClasses; // Restore original class
                            setTimeout(playNextItem, pauseDuration - flashDuration);
                        }, flashDuration);
                        
                        i++;
                    } else {
                        // Re-enable buttons
                        demoButton.disabled = false;
                        demoButton.innerHTML = '‚ñ∂'; 
                        inputKeys.forEach(key => key.disabled = false);
                        renderSequences(); // Redraw to reset current turn highlight
                    }
                }
                playNextItem();
            }

            function flashKey(value, duration) {
                const key = document.querySelector(`#piano-pad button[data-value="${value}"]`);
                if (key) {
                    key.classList.add('flash');
                    setTimeout(() => key.classList.remove('flash'), duration);
                }
            }
            
            function handlePianoDemo() {
                const state = appState['piano'];
                const sequenceToPlay = state.sequences[0]; 
                const demoButton = document.querySelector('#piano-pad button[data-action="demo"]');
                const speedMultiplier = getSpeedMultiplier('piano');
                const currentDelayMs = DEMO_DELAY_BASE_MS / speedMultiplier;

                if (sequenceToPlay.length === 0 || (demoButton && demoButton.disabled)) {
                    // Only show modal if triggered by user, not autoplay
                    if (!settings.isPianoAutoplayEnabled || (demoButton && demoButton.disabled)) {
                         if (demoButton && demoButton.disabled) return; 
                        showModal('No Sequence', 'The sequence is empty. Enter some notes first!', () => closeModal(), 'OK', '');
                    }
                    return;
                }

                // Disable buttons
                demoButton.disabled = true;
                const keys = document.querySelectorAll('#piano-pad button[data-value]');
                keys.forEach(key => key.disabled = true);
                // Re-enable control buttons
                document.querySelector('#piano-pad button[data-action="backspace"]').disabled = false;
                document.querySelector('#piano-pad button[data-action="open-settings"]').disabled = false;

                let i = 0;
                const flashDuration = currentDelayMs * 0.8; 

                function playNextKey() {
                    if (i < sequenceToPlay.length) {
                        const value = sequenceToPlay[i];
                        demoButton.innerHTML = String(i + 1); 
                        speak(PIANO_SPEAK_MAP[value] || value); 
                        flashKey(value, flashDuration);
                        i++;
                        setTimeout(playNextKey, currentDelayMs);
                    } else {
                        // Re-enable buttons
                        demoButton.disabled = false;
                        demoButton.innerHTML = '‚ñ∂'; 
                        keys.forEach(key => key.disabled = false);
                    }
                }
                playNextKey();
            }

            function advanceToNextRound() {
                const state = appState['rounds15'];
                state.currentRound++;
                if (state.currentRound > state.maxRound) {
                    state.currentRound = 1; // Loop back
                    showModal('Complete!', `You finished all ${state.maxRound} rounds. Resetting to Round 1.`, () => closeModal(), 'OK', '');
                }
                renderSequences(); 
                // Re-enable all keys for the new round
                const allKeys = document.querySelectorAll('#rounds15-pad button[data-value]');
                allKeys.forEach(key => key.disabled = false);
            }

            function resetRounds15() {
                const state = appState['rounds15'];
                state.currentRound = 1;
                state.sequences[0] = [];
                state.nextSequenceIndex = 0;
                const allKeys = document.querySelectorAll('#rounds15-pad button[data-value]');
                allKeys.forEach(key => key.disabled = false);
                renderSequences();
            }
            
            /**
             * Clears the 15-rounds sequence with a rapid delete animation.
             */
            function clearRounds15Sequence() {
                const state = appState['rounds15'];
                const sequence = state.sequences[0];
                
                if (sequence.length === 0) {
                    advanceToNextRound();
                    return;
                }
                
                if (speedDeleteInterval) clearInterval(speedDeleteInterval);
                speedDeleteInterval = null;

                function rapidDelete() {
                    if (sequence.length > 0) {
                        sequence.pop();
                        state.nextSequenceIndex--;
                        renderSequences();
                    } else {
                        clearInterval(speedDeleteInterval);
                        speedDeleteInterval = null;
                        advanceToNextRound(); 
                    }
                }
                // Start the rapid delete
                setTimeout(() => {
                    speedDeleteInterval = setInterval(rapidDelete, SPEED_DELETE_INTERVAL_MS);
                }, 10);
            }

            function handleRounds15Demo() {
                const state = appState['rounds15'];
                const sequenceToPlay = state.sequences[0]; 
                const demoButton = document.querySelector('#rounds15-pad button[data-action="demo"]');
                const allKeys = document.querySelectorAll('#rounds15-pad button[data-value]');
                const speedMultiplier = settings.rounds15SpeedMultiplier;
                const currentDelayMs = DEMO_DELAY_BASE_MS / speedMultiplier;

                if (sequenceToPlay.length === 0 || (demoButton.disabled && !settings.isRounds15ClearAfterPlaybackEnabled) ) {
                    if (demoButton && demoButton.disabled && !settings.isRounds15ClearAfterPlaybackEnabled) return;
                    showModal('No Sequence', 'The sequence is empty. Enter some numbers first!', () => closeModal(), 'OK', '');
                    allKeys.forEach(key => key.disabled = false);
                    return;
                }

                // Disable buttons
                demoButton.disabled = true;
                allKeys.forEach(key => key.disabled = true);
                // Re-enable control buttons
                document.querySelector('#rounds15-pad button[data-action="backspace"]').disabled = false;
                document.querySelector('#rounds15-pad button[data-action="open-settings"]').disabled = false;
                document.querySelector('#rounds15-pad button[data-action="reset-rounds"]').disabled = false;

                let i = 0;
                const flashDuration = 250 * (speedMultiplier > 1 ? (1/speedMultiplier) : 1);
                const pauseDuration = currentDelayMs; 

                function playNextNumber() {
                    if (i < sequenceToPlay.length) {
                        const value = sequenceToPlay[i]; 
                        const key = document.querySelector(`#rounds15-pad button[data-value="${value}"]`);
                        demoButton.innerHTML = String(i + 1); 
                        speak(value); 
                        if (key) {
                            key.classList.add('demo-flash-rounds15');
                            setTimeout(() => {
                                key.classList.remove('demo-flash-rounds15');
                                setTimeout(playNextNumber, pauseDuration - flashDuration);
                            }, flashDuration); 
                        } else {
                            setTimeout(playNextNumber, pauseDuration);
                        }
                        i++;
                    } else {
                        // Demo finished
                        demoButton.disabled = false;
                        demoButton.innerHTML = '‚ñ∂'; 
                        
                        if (settings.isRounds15ClearAfterPlaybackEnabled) {
                            // Automatically clear and advance
                            setTimeout(clearRounds15Sequence, 300); 
                        } else {
                            // Manually re-enable keys
                            allKeys.forEach(key => key.disabled = false);
                        }
                    }
                }
                playNextNumber();
            }

            // --- Modal/Message Box Implementation ---
            
            function showModal(title, message, onConfirm, confirmText = 'OK', cancelText = 'Cancel') {
                if (!customModal) return;
                
                // Set text
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-message').textContent = message;
                
                const oldConfirmBtn = document.getElementById('modal-confirm');
                const oldCancelBtn = document.getElementById('modal-cancel');
                
                // Clone buttons to remove old event listeners
                const newConfirmBtn = oldConfirmBtn.cloneNode(true); 
                newConfirmBtn.textContent = confirmText;
                oldConfirmBtn.parentNode.replaceChild(newConfirmBtn, oldConfirmBtn); 
                
                const newCancelBtn = oldCancelBtn.cloneNode(true);
                newCancelBtn.textContent = cancelText;
                oldCancelBtn.parentNode.replaceChild(newCancelBtn, oldCancelBtn);

                // Add new listeners
                newConfirmBtn.addEventListener('click', () => { onConfirm(); closeModal(); }); 
                newCancelBtn.addEventListener('click', closeModal); 
                
                // Show/hide cancel button
                newCancelBtn.style.display = cancelText ? 'inline-block' : 'none';
                
                // Set confirm button style (in case it was changed)
                newConfirmBtn.className = 'px-4 py-2 text-white rounded-lg transition-colors font-semibold bg-primary-app hover:bg-secondary-app';
                
                // Show modal
                setTimeout(() => {
                    customModal.classList.remove('opacity-0', 'pointer-events-none');
                    customModal.querySelector('div').classList.remove('scale-90');
                }, 10);
            }

            function closeModal() {
                if (customModal) {
                    customModal.querySelector('div').classList.add('scale-90');
                    customModal.classList.add('opacity-0');
                    setTimeout(() => customModal.classList.add('pointer-events-none'), 300);
                }
            }

            // --- NEW: Voice Input Functions ---

            /**
             * Processes the transcript from speech recognition.
             */
            function processVoiceTranscript(transcript) {
                if (!transcript) return;
                
                const words = transcript.toLowerCase().replace(/[\.,]/g, '').split(' ');
                
                for (const word of words) {
                    const command = VOICE_COMMAND_MAP[word] || word; // Check map, else use word
                    
                    if (command === 'BACKSPACE') {
                        handleBackspace();
                    } else if (command === 'RESET' && currentMode === 'rounds15') {
                        resetRounds15();
                    } else {
                        // Check if 'command' is a valid input for the current mode
                        if (currentMode === 'bananas' || currentMode === 'follows') {
                            if (/^[1-9]$/.test(command)) addValue(command);
                        } else if (currentMode === 'piano') {
                            if ((/^[1-5]$/.test(command) || /^[A-G]$/.test(command))) addValue(command);
                        } else if (currentMode === 'rounds15') {
                            if (/^(?:[1-9]|1[0-2])$/.test(command)) addValue(command);
                        }
                    }
                }
            }

            function handleVoiceResult(event) {
                const transcript = event.results[0][0].transcript.trim();
                processVoiceTranscript(transcript);
            }

            function handleVoiceError(event) {
                console.error('Voice Error:', event.error);
                if (event.error === 'not-allowed') {
                    showModal('Permission Denied', 'You have blocked microphone access. To use voice input, please allow microphone access in your browser settings.', () => closeModal(), 'OK', '');
                    // Disable the feature
                    settings.isVoiceInputEnabled = false;
                    voiceInputToggle.checked = false;
                    updateMicButtonVisibility();
                } else if (event.error === 'no-speech') {
                    // Do nothing, user just didn't speak
                }
                stopListening();
            }
            
            function stopListening() {
                if (!isListening) return;
                isListening = false;
                if(recognitionApi) recognitionApi.stop();
                
                // Reset all mic buttons
                allMicButtons.forEach(btn => {
                    btn.classList.remove('voice-active');
                    btn.innerHTML = 'üé§';
                });
            }
            
            function startListening() {
                if (!recognitionApi || isListening) return;
                
                isListening = true;
                
                // Style the current button
                const currentMicButton = document.querySelector(`#${currentMode}-pad button[data-action="voice-input"]`);
                if (currentMicButton) {
                    currentMicButton.classList.add('voice-active');
                    currentMicButton.innerHTML = '...';
                }

                try {
                    recognitionApi.lang = 'en-US';
                    recognitionApi.continuous = false;
                    recognitionApi.interimResults = false;
                    recognitionApi.maxAlternatives = 1;
                    
                    recognitionApi.onresult = handleVoiceResult;
                    recognitionApi.onend = stopListening;
                    recognitionApi.onerror = handleVoiceError;
                    
                    recognitionApi.start();
                } catch (err) {
                    console.error("Failed to start recognition:", err);
                    stopListening();
                }
            }


            // --- Event Listeners Setup ---
            
            /**
             * Initializes all application-wide event listeners.
             */
            function initializeListeners() {
                
                // 1. GLOBAL CLICK LISTENER (Event Delegation)
                document.addEventListener('click', (event) => {
                    const button = event.target.closest('button');
                    if (!button) return;

                    const { value, action, mode, modeSelect, copyTarget } = button.dataset;

                    // A. Handle Copy Button
                    if (copyTarget) {
                        const targetElement = document.getElementById(copyTarget);
                        if (targetElement) {
                            // Use document.execCommand for iFrame compatibility
                            targetElement.select();
                            try {
                                document.execCommand('copy');
                                const originalText = button.innerHTML;
                                button.innerHTML = "Copied!";
                                button.classList.add('copied');
                                setTimeout(() => {
                                    button.innerHTML = originalText;
                                    button.classList.remove('copied');
                                }, 2000);
                            } catch (err) {
                                console.error('Failed to copy text: ', err);
                                // Fallback for modern browsers (might fail in iFrame)
                                // Note: navigator.clipboard may be blocked in sandboxed iFrames
                                navigator.clipboard.writeText(targetElement.value).then(() => {
                                    /* ... success ... */
                                }).catch(err => {
                                    console.error('Clipboard API failed: ', err);
                                });
                            }
                        }
                        return;
                    }
                    
                    // B. Handle Modal/Settings Actions
                    if (action === 'open-settings') {
                        openSettingsModal();
                        return;
                    }
                    if (action === 'open-help') {
                        closeSettingsModal();
                        openHelpModal();
                        return;
                    }
                    if (modeSelect) {
                        handleModeSelection(modeSelect);
                        return;
                    }

                    // C. Handle Demo / Reset Actions
                    if (action === 'reset-rounds' && mode === 'rounds15') {
                        resetRounds15();
                        return;
                    }
                    if (action === 'play-demo' && mode === 'bananas') {
                        handleBananasDemo();
                        return;
                    }
                    if (action === 'play-demo' && mode === 'follows') {
                        handleFollowsDemo();
                        return;
                    }
                    if (action === 'demo' && mode === 'piano') {
                        handlePianoDemo();
                        return;
                    }
                    if (action === 'demo' && mode === 'rounds15') {
                        handleRounds15Demo();
                        return;
                    }

                    // D. NEW: Handle Voice Input
                    if (action === 'voice-input' && mode === currentMode) {
                        if (isListening) {
                            stopListening();
                        } else {
                            startListening();
                        }
                        return;
                    }
                    
                    // E. Handle Value Input (Check if button's mode matches current mode)
                    if (value && mode === currentMode) {
                        if ((currentMode === 'bananas' || currentMode === 'follows') && /^[1-9]$/.test(value)) {
                            addValue(value);
                        }
                        else if (currentMode === 'piano' && (/^[1-5]$/.test(value) || /^[A-G]$/.test(value))) {
                            if (!settings.isPianoAutoplayEnabled) flashKey(value, 200); // Manual flash
                            addValue(value);
                        }
                        else if (currentMode === 'rounds15' && /^(?:[1-9]|1[0-2])$/.test(value)) {
                            addValue(value);
                        }
                    }
                });
                
                // 2. BACKSPACE SPEED DELETE LISTENERS (Mouse + Touch)
                document.querySelectorAll('button[data-action="backspace"]').forEach(btn => {
                    btn.addEventListener('mousedown', handleBackspaceStart);
                    btn.addEventListener('mouseup', handleBackspaceEnd);
                    btn.addEventListener('mouseleave', stopSpeedDeleting);
                    btn.addEventListener('touchstart', handleBackspaceStart, { passive: false });
                    btn.addEventListener('touchend', handleBackspaceEnd);
                });
                
                // 3. SETTINGS MODAL LISTENERS 
                settingsModeToggleButton.addEventListener('click', toggleModeDropdown);
                document.getElementById('close-settings').addEventListener('click', closeSettingsModal);
                
                // "follows" mode settings
                followsCountSelect.addEventListener('change', (event) => {
                    const newCount = parseInt(event.target.value);
                    const state = appState['follows'];
                    state.sequenceCount = newCount;
                    state.nextSequenceIndex = 0; // Reset index on change
                    renderSequences(); 
                });
                followsChunkSizeSelect.addEventListener('change', (event) => {
                    settings.followsChunkSize = parseInt(event.target.value);
                });
                
                // Toggles
                darkModeToggle.addEventListener('change', (e) => updateTheme(e.target.checked));
                speedDeleteToggle.addEventListener('change', (e) => settings.isSpeedDeletingEnabled = e.target.checked);
                pianoAutoplayToggle.addEventListener('change', (e) => settings.isPianoAutoplayEnabled = e.target.checked);
                bananasAutoplayToggle.addEventListener('change', (e) => settings.isBananasAutoplayEnabled = e.target.checked);
                followsAutoplayToggle.addEventListener('change', (e) => settings.isFollowsAutoplayEnabled = e.target.checked);
                rounds15ClearAfterPlaybackToggle.addEventListener('change', (e) => settings.isRounds15ClearAfterPlaybackEnabled = e.target.checked);
                audioPlaybackToggle.addEventListener('change', (e) => {
                    settings.isAudioPlaybackEnabled = e.target.checked;
                    if (settings.isAudioPlaybackEnabled) speak("Audio"); // Pre-load voice
                });
                // NEW: Voice Input Toggle Listener
                voiceInputToggle.addEventListener('change', (e) => {
                    settings.isVoiceInputEnabled = e.target.checked;
                    updateMicButtonVisibility();
                    if (settings.isVoiceInputEnabled && !recognitionApi) {
                        showModal('Not Supported', 'Your browser does not support the Web Speech API. The mic button will be hidden.', () => {
                            settings.isVoiceInputEnabled = false;
                            voiceInputToggle.checked = false;
                            updateMicButtonVisibility();
                            closeModal();
                        }, 'OK', '');
                    }
                });
                sliderLockToggle.addEventListener('change', (e) => {
                    settings.areSlidersLocked = e.target.checked;
                    updateSliderLockState();
                });

                // Speed Sliders
                function setupSpeedSlider(slider, displayElement, modeKey) {
                    slider.addEventListener('input', (event) => {
                        const multiplier = parseInt(event.target.value) / 100;
                        updateModeSpeed(modeKey, multiplier);
                        updateSpeedDisplay(multiplier, displayElement);
                    });
                }
                setupSpeedSlider(bananasSpeedSlider, bananasSpeedDisplay, 'bananas');
                setupSpeedSlider(pianoSpeedSlider, pianoSpeedDisplay, 'piano');
                setupSpeedSlider(rounds15SpeedSlider, rounds15SpeedDisplay, 'rounds15');
                
                // UI Scale Slider
                uiScaleSlider.addEventListener('input', (event) => {
                    const multiplier = parseInt(event.target.value) / 100;
                    settings.uiScaleMultiplier = multiplier;
                    updateScaleDisplay(multiplier, uiScaleDisplay);
                    renderSequences(); // Re-render to apply new size
                });
                
                // 4. HELP MODAL LISTENER
                document.getElementById('close-help').addEventListener('click', closeHelpModal);
            }
            
            // --- Initialization ---
            window.onload = function() {
                
                // --- PWA: Service Worker Registration ---
                if ('serviceWorker' in navigator) {
                    // We create the service worker content as a string
                    const swContent = `
                        /* A minimal service worker to enable PWA installability.
                           It doesn't cache anything, just passes requests through.
                           This allows the app to be installable while keeping everything in one file.
                        */
                        self.addEventListener('fetch', (event) => {
                            // Pass-through fetch
                            event.respondWith(fetch(event.request));
                        });
                    `;
                    
                    try {
                        // Create a "virtual" file for the service worker
                        const blob = new Blob([swContent], { type: 'application/javascript' });
                        const swUrl = URL.createObjectURL(blob);
                        
                        // Register the virtual file
                        navigator.serviceWorker.register(swUrl)
                            .then((registration) => {
                                console.log('Service Worker registered with scope:', registration.scope);
                            })
                            .catch((error) => {
                                console.error('Service Worker registration failed:', error);
                            });
                    } catch (error) {
                        console.error('Failed to create Service Worker Blob:', error);
                    }
                }
                // --- End PWA Registration ---

                // Apply defaults on load
                updateTheme(settings.isDarkMode);
                updateSpeedDisplay(settings.bananasSpeedMultiplier, bananasSpeedDisplay);
                updateSpeedDisplay(settings.pianoSpeedMultiplier, pianoSpeedDisplay);
                updateSpeedDisplay(settings.rounds15SpeedMultiplier, rounds15SpeedDisplay);
                updateScaleDisplay(settings.uiScaleMultiplier, uiScaleDisplay);
                updateSliderLockState(); // Apply default lock
                updateMicButtonVisibility(); // NEW: Show/hide mic buttons
                
                // NEW: Check for voice support on load
                if (settings.isVoiceInputEnabled && !recognitionApi) {
                    showModal('Voice Not Supported', 'Your browser does not support the Web Speech API. The mic button will be hidden.', () => {
                        settings.isVoiceInputEnabled = false;
                        voiceInputToggle.checked = false;
                        updateMicButtonVisibility();
                        closeModal();
                    }, 'OK', '');
                }
                
                // Setup all event listeners
                initializeListeners();
                
                // Start in 'bananas' mode
                updateMode('bananas');
                
                // Pre-load voice engine
                if (settings.isAudioPlaybackEnabled) speak(" "); 
            };

        })(); // End IIFE
    </script>

</body>
</html>

