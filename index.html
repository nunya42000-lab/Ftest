<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevOS Workspace</title>
    <link rel="manifest" href="./manifest.json">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jshint/2.13.6/jshint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.9/beautify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.9/beautify-html.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.9/beautify-css.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/htmlmixed/htmlmixed.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closetag.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/xml-fold.min.js"></script>

    <style>
        :root {
            --bg: #0d1117;
            --surface: #161b22;
            --surface-light: #21262d;
            --border: #30363d;
            --text: #c9d1d9;
            --accent: #2f81f7;
            --success: #238636;
            --warn: #d29922;
            --danger: #f85149;
        }
        body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        * { box-sizing: border-box; }
        
        button { cursor: pointer; border: none; border-radius: 6px; font-weight: 600; padding: 6px 12px; }
        .btn-primary { background: var(--success); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        input[type="text"] { background: var(--surface); border: 1px solid var(--border); color: var(--text); padding: 6px; border-radius: 4px; width: 100%; margin-bottom: 10px; }
        
        .app-container { display: flex; flex: 1; overflow: hidden; }
        
        /* Sidebar Styling */
        .sidebar { width: 250px; background: var(--surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; transition: transform 0.3s ease; }
        @media (max-width: 768px) { .sidebar { position: absolute; z-index: 100; height: 100%; transform: translateX(-100%); } .sidebar.open { transform: translateX(0); } }
        
        /* Main Layout */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .tab-bar { display: flex; background: var(--surface); border-bottom: 1px solid var(--border); align-items: center; }
        .tab { padding: 10px 15px; cursor: pointer; border-bottom: 2px solid transparent; font-weight: 500;}
        .tab.active { border-bottom-color: var(--accent); color: var(--accent); }
        .panel-box { display: none; flex: 1; overflow-y: auto; padding: 15px; }
        .panel-box.active { display: block; }
        
        /* Editor Flex Layout */
        #view-editor { padding: 0; display: none; flex-direction: column; height: 100%; overflow: hidden; }
        #view-editor.active { display: flex; }
        .CodeMirror { flex: 1; height: auto; font-size: 14px; }
        
        /* Mobile Quick-Symbol Toolbar */
        #mobile-toolbar { display: flex; overflow-x: auto; background: var(--surface); padding: 6px; gap: 6px; border-bottom: 1px solid var(--border); scrollbar-width: none; }
        #mobile-toolbar::-webkit-scrollbar { display: none; }
        .tool-btn { background: var(--surface-light); color: var(--accent); border: 1px solid var(--border); padding: 8px 16px; border-radius: 6px; font-family: monospace; font-size: 16px; font-weight: bold; white-space: nowrap; touch-action: manipulation; }
        .tool-btn:active { background: var(--accent); color: #fff; }

        /* Preview & Console Interceptor Output */
        #preview-container { flex: 1; border-top: 1px solid var(--border); display: flex; flex-direction: column; background: #fff; min-height: 250px;}
        iframe { border: none; flex: 1; width: 100%; }
        #console-output { background: #000; color: #0f0; font-family: monospace; font-size: 12px; padding: 10px; height: 150px; overflow-y: auto; border-top: 1px solid var(--border); margin: 0; }
        .log-msg { margin-bottom: 4px; border-bottom: 1px dashed #333; padding-bottom: 2px;}
        .log-error { color: #ff5555; margin-bottom: 4px; border-bottom: 1px dashed #333;}
        
        .status-flash { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--accent); color: white; padding: 8px 16px; border-radius: 20px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 1000;}
    </style>
</head>
<body>
    <div class="tab-bar">
        <button class="btn-outline" style="margin: 5px; padding: 6px 10px;" onclick="document.getElementById('ui-sidebar').classList.toggle('open')">‚ò∞</button>
        <div class="tab active" onclick="switchTab('editor')">Code</div>
        <div class="tab" onclick="switchTab('tools')">Tools</div>
        <div class="tab" onclick="switchTab('vault')">Vault</div>
        <div style="flex:1"></div>
        <button class="btn-primary" style="margin: 5px;" onclick="runPreview()">‚ñ∂ Run</button>
    </div>

    <div class="app-container">
        <aside class="sidebar" id="ui-sidebar">
            <div style="padding: 15px; border-bottom: 1px solid var(--border);">
                <div class="file-upload-wrapper">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="font-size: 12px; font-weight: bold; color: var(--accent);">üìÅ WORKSPACE</span>
                    </div>
                    <button class="btn-primary" style="width:100%; padding: 6px;" onclick="createNewFile()">+ NEW FILE</button>
                    <input type="file" multiple id="file-input" onchange="loadFiles(event)" style="margin-top: 10px; width: 100%; font-size: 12px; color: transparent;">
                </div>
            </div>
            <div id="file-list" style="flex:1; overflow-y: auto;"></div>
            <div style="padding: 15px; border-top: 1px solid var(--border); display: flex; gap: 5px;">
                <button class="btn-outline" style="flex:1; font-size: 11px;" onclick="exportProject()">Export Zip</button>
            </div>
        </aside>

        <main class="main-content">
            
            <div id="view-editor" class="panel-box active">
                
                <div id="editor-header" style="padding: 10px; background: var(--surface); border-bottom: 1px solid var(--border); user-select: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 5px; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <strong id="current-file-label" style="color:var(--accent); font-size: 14px; word-break: break-all;">Swipe here to switch files</strong>
                            <button class="btn-outline" style="padding: 2px 8px; font-size: 11px;" onclick="renameCurrentFile()">‚úèÔ∏è Rename</button>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn-outline" style="padding: 2px 8px; font-size: 11px; color: var(--warn); border-color: var(--warn);" onclick="stripFileToSnippets()">‚úÇÔ∏è Strip File</button>
                            <button class="btn-outline" style="padding: 2px 8px; font-size: 11px;" onclick="extractCodeToFile()">üì¶ Extract</button>
                        </div>
                    </div>
                </div>
                
                <div id="mobile-toolbar">
                    <button class="tool-btn" onclick="insertSymbol('{')">{</button>
                    <button class="tool-btn" onclick="insertSymbol('}')">}</button>
                    <button class="tool-btn" onclick="insertSymbol('(')">(</button>
                    <button class="tool-btn" onclick="insertSymbol(')')">)</button>
                    <button class="tool-btn" onclick="insertSymbol(';')">;</button>
                    <button class="tool-btn" onclick="insertSymbol('=')">=</button>
                    <button class="tool-btn" onclick="insertSymbol('>')">&gt;</button>
                    <button class="tool-btn" onclick="insertSymbol('<')">&lt;</button>
                    <button class="tool-btn" onclick="insertSymbol('/')">/</button>
                    <button class="tool-btn" onclick="insertSymbol('`')">`</button>
                    <button class="tool-btn" onclick="insertSymbol('$', true)">${}</button>
                </div>
                
                <textarea id="code-editor"></textarea>
            </div>

            <div id="view-tools" class="panel-box">
                <h3>Diagnostics & Search</h3>
                <div style="margin-bottom: 15px;">
                    <button class="btn-outline" onclick="runLinter()">Run Strict Linter</button>
                    <div id="diagnostic-results" style="margin-top: 10px; font-size: 12px; background: var(--surface-light); padding: 10px; border-radius: 4px;"></div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <input type="text" id="search-query" placeholder="Search workspace...">
                    <input type="text" id="replace-query" placeholder="Replace with...">
                    <div style="display:flex; gap:10px;">
                        <button class="btn-outline" style="flex:1;" onclick="performSearch()">Search</button>
                        <button class="btn-outline" style="flex:1;" onclick="performReplace()">Replace All</button>
                    </div>
                    <div id="search-results" style="margin-top: 10px; font-size: 12px; max-height: 150px; overflow-y:auto;"></div>
                </div>

                <h3>Advanced Dev Tools</h3>
                <div style="margin-bottom: 20px; border: 1px solid var(--border); padding: 10px; border-radius: 6px;">
                    <h4 style="margin-top:0; margin-bottom:10px; color:var(--accent);">PWA Controller</h4>
                    <button class="btn-primary" onclick="clearPWACache()">Nuke SW & Caches</button>
                    <p style="font-size: 11px; color: #888; margin-top: 5px; margin-bottom:0;">Force-clears service workers and storage caches to ensure fresh reloads.</p>
                </div>

                <div style="margin-bottom: 20px; border: 1px solid var(--border); padding: 10px; border-radius: 6px;">
                    <h4 style="margin-top:0; margin-bottom:10px; color:var(--success);">Time Machine Backups</h4>
                    <div style="display:flex; gap:10px;">
                        <button class="btn-outline" style="flex:1;" onclick="takeSnapshot()">Take Snapshot</button>
                        <button class="btn-outline" style="flex:1;" onclick="renderSnapshots()">View History</button>
                    </div>
                    <div id="snapshot-list" style="margin-top: 10px; max-height: 150px; overflow-y: auto;"></div>
                </div>

                <div style="margin-bottom: 20px; border: 1px solid var(--border); padding: 10px; border-radius: 6px;">
                    <h4 style="margin-top:0; margin-bottom:10px; color:var(--warn);">Storage Explorer</h4>
                    <div style="display:flex; gap:10px;">
                        <button class="btn-outline" style="flex:1;" onclick="exploreStorage()">View Storage</button>
                        <button class="btn-outline" style="flex:1; color:var(--danger); border-color:var(--danger);" onclick="clearLocalStorage()">Clear Local</button>
                    </div>
                    <div id="storage-list" style="margin-top: 10px; font-family: monospace; font-size: 11px; overflow-wrap: anywhere;"></div>
                </div>
            </div>

            <div id="view-vault" class="panel-box">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>Snippet Vault</h3>
                    <button class="btn-outline" style="padding: 4px 10px; font-size: 12px;" onclick="createManualSnippet()">+ NEW</button>
                </div>
                <div id="snippet-list" style="overflow-y: auto; height:calc(100% - 60px); margin-top:10px;"></div>
            </div>

            <div id="preview-container">
                <iframe id="preview-frame"></iframe>
                <div id="console-output"></div>
            </div>
        </main>
    </div>
    
    <div id="status-msg" class="status-flash">Saved</div>
        <script>
        let vfs = {};
        let currentFileName = null;
        let cmEditor = null;
        let saveTimer = null;
        let snippets = [];
        let snapshots = [];

        // --- Initialization ---
        async function init() {
            cmEditor = CodeMirror.fromTextArea(document.getElementById("code-editor"), {
                mode: "javascript",
                theme: "dracula",
                lineNumbers: true,
                autoCloseBrackets: true,
                autoCloseTags: true,
                viewportMargin: Infinity,
                lineWrapping: true
            });

            cmEditor.on('change', triggerAutoSave);

            const savedVfs = await localforage.getItem('devos_vfs');
            if (savedVfs) vfs = savedVfs;
            
            const savedSnippets = await localforage.getItem('vault_snippets');
            if (savedSnippets) snippets = savedSnippets;

            await loadSnapshots();
            
            rebuildSidebar();
            renderVault();
            if (Object.keys(vfs).length > 0) openFile(Object.keys(vfs)[0]);

            // Register Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW Registration failed', err));
            }

            // Listen for Console Interceptor Messages
            window.addEventListener('message', (e) => {
                if (e.data && e.data.type === 'devos-console') {
                    const out = document.getElementById('console-output');
                    const cssClass = e.data.level === 'error' ? 'log-error' : 'log-msg';
                    const prefix = e.data.level === 'error' ? '‚ùå ' : '‚ñ∂ ';
                    out.innerHTML += `<div class="${cssClass}">${prefix}${e.data.msg}</div>`;
                    out.scrollTop = out.scrollHeight;
                }
            });

            // Start Auto-Snapshot Interval (15 mins)
            setInterval(takeSnapshot, 15 * 60 * 1000);
        }

        // --- Core UI & File System ---
        function switchTab(tabId) {
            document.querySelectorAll('.panel-box').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${tabId}`).classList.add('active');
            event.currentTarget.classList.add('active');
            if (tabId === 'editor') cmEditor.refresh();
        }

        function flashSaveStatus(msg = "Saved") {
            const el = document.getElementById('status-msg');
            el.innerText = msg;
            el.style.opacity = 1;
            setTimeout(() => el.style.opacity = 0, 1500);
        }

        function triggerAutoSave() {
            clearTimeout(saveTimer);
            saveTimer = setTimeout(async () => {
                if (currentFileName) vfs[currentFileName] = cmEditor.getValue();
                await localforage.setItem('devos_vfs', vfs);
                flashSaveStatus();
            }, 1000);
        }

        function rebuildSidebar() {
            const list = document.getElementById('file-list');
            list.innerHTML = '';
            for (const fn of Object.keys(vfs)) {
                const el = document.createElement('div');
                el.style.cssText = `padding: 10px 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: ${fn === currentFileName ? 'var(--surface-light)' : 'transparent'}`;
                
                const nameSpan = document.createElement('span');
                nameSpan.innerText = fn;
                nameSpan.style.cssText = `color: ${fn === currentFileName ? 'var(--accent)' : 'var(--text)'}; font-size: 14px; cursor: pointer; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;`;
                nameSpan.onclick = () => { openFile(fn); document.getElementById('ui-sidebar').classList.remove('open'); };
                
                const delBtn = document.createElement('button');
                delBtn.innerText = 'üóëÔ∏è';
                delBtn.style.cssText = "background:transparent; border:none; padding:2px; font-size:12px;";
                delBtn.onclick = (e) => {
                    e.stopPropagation();
                    if(confirm(`Delete ${fn}?`)) {
                        delete vfs[fn];
                        if(currentFileName === fn) { cmEditor.setValue(''); currentFileName = null; }
                        rebuildSidebar();
                        triggerAutoSave();
                    }
                };
                
                el.appendChild(nameSpan);
                el.appendChild(delBtn);
                list.appendChild(el);
            }
        }

        function openFile(fn) {
            if (currentFileName) vfs[currentFileName] = cmEditor.getValue();
            currentFileName = fn;
            cmEditor.setValue(vfs[fn] || '');
            
            const ext = fn.split('.').pop().toLowerCase();
            let mode = "javascript";
            if (ext === "html") mode = "htmlmixed";
            else if (ext === "css") mode = "css";
            else if (ext === "json") mode = "application/json";
            
            cmEditor.setOption("mode", mode);
            document.getElementById('current-file-label').innerText = fn;
            rebuildSidebar();
            switchTab('editor');
        }

        // --- File Management ---
        async function loadFiles(e) {
            const files = e.target.files;
            for (let i = 0; i < files.length; i++) {
                const f = files[i];
                const text = await f.text();
                vfs[f.name] = text;
            }
            rebuildSidebar();
            triggerAutoSave();
        }

        function createNewFile() {
            const fn = prompt("Enter new filename (e.g., module.js, styles.css):");
            if (!fn || vfs[fn]) return alert("Invalid or duplicate name.");
            
            let boilerplate = '';
            if (fn.endsWith('.html')) boilerplate = '<!DOCTYPE html>\n<html lang="en">\n<head>\n\t<meta charset="UTF-8">\n\t<title>New Document</title>\n</head>\n<body>\n\n</body>\n</html>';
            else if (fn.endsWith('.js')) boilerplate = '// New Module\n';
            
            vfs[fn] = boilerplate;
            rebuildSidebar();
            openFile(fn);
            triggerAutoSave();
        }

        function renameCurrentFile() {
            if (!currentFileName) return;
            const newName = prompt("Rename file to:", currentFileName);
            if (!newName || newName === currentFileName || vfs[newName]) return;
            
            const oldName = currentFileName;
            vfs[newName] = vfs[oldName];
            delete vfs[oldName];
            
            updateImportsAcrossWorkspace(oldName, newName);
            
            currentFileName = newName;
            rebuildSidebar();
            openFile(newName);
            triggerAutoSave();
        }

        function updateImportsAcrossWorkspace(oldName, newName) {
            let updatedCount = 0;
            const regexWithDotSlash = new RegExp(`(['"\`])\\.\\/${oldName}\\1`, 'g');
            const regexWithoutDotSlash = new RegExp(`(['"\`])${oldName}\\1`, 'g');

            for (const [filename, content] of Object.entries(vfs)) {
                if (filename === newName) continue;
                if (!filename.endsWith('.js') && !filename.endsWith('.html')) continue;

                let newContent = content;
                newContent = newContent.replace(regexWithDotSlash, `$1./${newName}$1`);
                newContent = newContent.replace(regexWithoutDotSlash, `$1${newName}$1`);

                if (newContent !== content) {
                    vfs[filename] = newContent;
                    updatedCount++;
                }
            }
            if (updatedCount > 0) flashSaveStatus(`Updated imports in ${updatedCount} files`);
        }

        // --- Mobile Toolbar & Gestures ---
        function insertSymbol(sym, isTemplate = false) {
            if(!cmEditor) return;
            const cursor = cmEditor.getCursor();
            if (isTemplate) {
                cmEditor.replaceRange('${}', cursor);
                cmEditor.setCursor({line: cursor.line, ch: cursor.ch + 2});
            } else {
                cmEditor.replaceRange(sym, cursor);
                cmEditor.setCursor({line: cursor.line, ch: cursor.ch + 1});
            }
            cmEditor.focus();
        }

        let touchStartX = 0;
        const headerEl = document.getElementById('editor-header');
        headerEl.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, {passive: true});
        headerEl.addEventListener('touchend', e => {
            let diff = e.changedTouches[0].screenX - touchStartX;
            if (Math.abs(diff) > 60) {
                const files = Object.keys(vfs);
                if (files.length === 0) return;
                let idx = files.indexOf(currentFileName);
                if (diff < 0 && idx < files.length - 1) openFile(files[idx + 1]);
                else if (diff > 0 && idx > 0) openFile(files[idx - 1]);
            }
        }, {passive: true});

        // --- Modularization & Code Tools ---
        async function extractCodeToFile() {
            const selectedCode = cmEditor.getSelection();
            if(!selectedCode) return alert("Highlight code to extract.");
            const newFileName = prompt("Enter new filename (e.g., ui.js):");
            if(!newFileName) return;

            const ext = currentFileName.split('.').pop().toLowerCase();
            let replacement = '';
            let newContent = selectedCode;

            if (ext === 'js') {
                const cleanName = newFileName.replace('.js', '').replace(/[^a-zA-Z0-9]/g, '');
                const exportName = prompt("Enter export function name (leave blank for standard):", `init${cleanName}`);
                if (exportName) {
                    newContent = `export function ${exportName}() {\n${selectedCode}\n}`;
                    replacement = `import { ${exportName} } from './${newFileName}';\n\n// TODO: Execute ${exportName}()`;
                } else {
                    replacement = `import * as Module from './${newFileName}';`;
                }
            } else if (ext === 'html') {
                replacement = `<script src="${newFileName}"><\/script>`;
            }
            
            vfs[newFileName] = newContent;
            cmEditor.replaceSelection(replacement);
            triggerAutoSave();
            rebuildSidebar();
            flashSaveStatus("Extracted");
        }

        async function stripFileToSnippets() {
            if (!currentFileName || !currentFileName.endsWith('.js')) return alert("Only supports .js files.");
            const code = cmEditor.getValue();
            if (!confirm("Strip top-level functions and constants to Vault?")) return;

            let remainingCode = "", currentBlock = "", blockName = "";
            let braceDepth = 0, capturing = false, newSnippetsCount = 0;
            const lines = code.split('\n');
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                if (!capturing && braceDepth === 0) {
                    const funcMatch = line.match(/^(?:export\s+)?(?:async\s+)?function\s+([a-zA-Z0-9_]+)/);
                    const constMatch = line.match(/^(?:export\s+)?(?:const|let|var)\s+([a-zA-Z0-9_]+)\s*=/);
                    if (funcMatch || constMatch) {
                        capturing = true;
                        blockName = funcMatch ? funcMatch[1] : constMatch[1];
                        currentBlock = "";
                    }
                }

                if (capturing) {
                    currentBlock += line + '\n';
                    const cleanLine = line.replace(/(["'`]).*?\1/g, ''); 
                    braceDepth += ((cleanLine.match(/\{/g) || []).length - (cleanLine.match(/\}/g) || []).length);

                    if (braceDepth === 0) {
                        snippets.push({ name: `${currentFileName.replace('.js','')}: ${blockName}`, code: currentBlock.trim() });
                        newSnippetsCount++;
                        capturing = false; blockName = ""; currentBlock = "";
                    }
                } else {
                    remainingCode += line + '\n';
                }
            }

            if (newSnippetsCount > 0) {
                remainingCode = remainingCode.replace(/\n\s*\n/g, '\n\n').trim();
                vfs[currentFileName] = remainingCode;
                cmEditor.setValue(remainingCode);
                triggerAutoSave();
                await localforage.setItem('vault_snippets', snippets);
                renderVault();
                flashSaveStatus(`Stripped ${newSnippetsCount} items`);
            } else {
                alert("No target structures found.");
            }
        }

        // --- Snippet Vault ---
        async function createManualSnippet() {
            const name = prompt("Enter snippet name:");
            if (!name) return;
            const code = prompt("Paste snippet code:");
            if (code !== null) {
                snippets.push({ name, code });
                await localforage.setItem('vault_snippets', snippets);
                renderVault();
            }
        }

        function renderVault() {
            const list = document.getElementById('snippet-list');
            list.innerHTML = snippets.map((s, i) => `
                <div style="background:var(--surface-light); padding:10px; margin-bottom:10px; border-radius:6px; border:1px solid var(--border);">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <strong style="color:var(--accent); font-size:12px;">${s.name}</strong>
                        <div>
                            <button class="btn-outline" style="padding:2px 6px; font-size:10px;" onclick="insertSnippet(${i})">Insert</button>
                            <button class="btn-outline" style="padding:2px 6px; font-size:10px; color:var(--danger); border-color:var(--danger);" onclick="deleteSnippet(${i})">X</button>
                        </div>
                    </div>
                    <pre style="margin:0; font-size:10px; color:#888; overflow:hidden; max-height:40px;">${s.code}</pre>
                </div>
            `).join('') || '<div style="font-size:12px; color:#888;">Vault is empty.</div>';
        }

        function insertSnippet(idx) {
            if(!cmEditor) return;
            cmEditor.replaceRange(snippets[idx].code, cmEditor.getCursor());
            switchTab('editor');
        }

        async function deleteSnippet(idx) {
            if(confirm("Delete snippet?")) {
                snippets.splice(idx, 1);
                await localforage.setItem('vault_snippets', snippets);
                renderVault();
            }
        }

        // --- Live Preview & Console Interceptor ---
        const consoleInterceptorScript = `
        <script>
            const _log = console.log;
            const _err = console.error;
            console.log = function(...args) {
                _log(...args);
                window.parent.postMessage({ type: 'devos-console', level: 'log', msg: args.join(' ') }, '*');
            };
            console.error = function(...args) {
                _err(...args);
                window.parent.postMessage({ type: 'devos-console', level: 'error', msg: args.join(' ') }, '*');
            };
            window.onerror = function(msg, url, line) {
                window.parent.postMessage({ type: 'devos-console', level: 'error', msg: msg + ' (Line ' + line + ')' }, '*');
            };
        <\/script>
        `;

        function runPreview() {
            if (currentFileName) vfs[currentFileName] = cmEditor.getValue();
            let html = vfs['index.html'] || '<h1>No index.html found</h1>';
            
            // Inject Module Scripts
            const scripts = Object.keys(vfs).filter(fn => fn.endsWith('.js') && fn !== 'sw.js');
            let scriptTags = scripts.map(fn => {
                const blob = new Blob([vfs[fn]], {type: 'application/javascript'});
                return `<script type="module" src="${URL.createObjectURL(blob)}"><\/script>`;
            }).join('\n');
            
            // Insert Console Interceptor & Scripts
            if(html.includes('<head>')) {
                html = html.replace('<head>', '<head>\n' + consoleInterceptorScript);
            } else {
                html = consoleInterceptorScript + html;
            }
            html = html.replace('</body>', scriptTags + '\n</body>');
            
            document.getElementById('console-output').innerHTML = ''; // Clear logs
            const frame = document.getElementById('preview-frame');
            frame.srcdoc = html;
        }

        // --- Advanced Tools ---
        async function loadSnapshots() {
            const stored = await localforage.getItem('devos_snapshots');
            if (stored) snapshots = stored;
        }

        async function takeSnapshot() {
            if (Object.keys(vfs).length === 0) return;
            const snap = { 
                id: Date.now(),
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), 
                data: JSON.parse(JSON.stringify(vfs)) 
            };
            snapshots.unshift(snap);
            if (snapshots.length > 15) snapshots.pop();
            await localforage.setItem('devos_snapshots', snapshots);
            flashSaveStatus("Snapshot Saved");
            renderSnapshots();
        }

        function renderSnapshots() {
            const list = document.getElementById('snapshot-list');
            list.innerHTML = snapshots.map(s => `
                <div style="display:flex; justify-content:space-between; border-bottom:1px solid var(--border); padding: 6px 0;">
                    <span style="font-size:12px; color:var(--text);">üïí ${s.time}</span>
                    <button class="btn-outline" style="padding: 2px 6px; font-size: 10px;" onclick="restoreSnapshot(${s.id})">Restore</button>
                </div>
            `).join('') || "<div style='font-size:12px; color:#888;'>No snapshots yet.</div>";
        }

        function restoreSnapshot(id) {
            if(!confirm("Warning: Overwrite workspace with snapshot?")) return;
            const snap = snapshots.find(s => s.id === id);
            if (snap) {
                vfs = JSON.parse(JSON.stringify(snap.data));
                rebuildSidebar();
                if(currentFileName && vfs[currentFileName]) openFile(currentFileName);
                else cmEditor.setValue("");
                triggerAutoSave();
                alert("Workspace restored!");
            }
        }

        async function clearPWACache() {
            try {
                if ('serviceWorker' in navigator) {
                    const regs = await navigator.serviceWorker.getRegistrations();
                    for(let r of regs) await r.unregister();
                }
                if ('caches' in window) {
                    const keys = await caches.keys();
                    for(let k of keys) await caches.delete(k);
                }
                alert("Service Workers & Caches purged. Refresh IDE.");
            } catch (err) { alert("Error: " + err.message); }
        }

        function exploreStorage() {
            const list = document.getElementById('storage-list');
            let html = '<strong style="color:var(--text);">LocalStorage Keys:</strong><br>';
            for (let i = 0; i < localStorage.length; i++) {
