<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevOS Workspace</title>
    <link rel="manifest" href="./manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jshint/2.13.6/jshint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <style>
        :root { --bg: #0d1117; --panel: #161b22; --accent: #2f81f7; --success: #238636; --danger: #f85149; --warn: #d29922; --text: #c9d1d9; --border: #30363d; --muted: #8b949e; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        header { background: var(--panel); padding: 10px 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .header-left { display: flex; align-items: center; gap: 10px; }
        .menu-btn { background: transparent; border: 1px solid var(--border); color: var(--text); font-size: 18px; padding: 4px 10px; border-radius: 4px; cursor: pointer; }
        
        .tabs { display: flex; gap: 8px; overflow-x: auto; white-space: nowrap; padding: 10px 15px; background: var(--panel); border-bottom: 1px solid var(--border); }
        .tab { padding: 8px 12px; background: #000; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: bold; color: var(--muted); }
        .tab.active { background: var(--accent); color: #fff; border-color: var(--accent); }

        .workspace { display: flex; flex: 1; overflow: hidden; position: relative; }
        .sidebar { position: absolute; z-index: 100; left: -260px; top: 0; width: 240px; height: 100%; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; transition: left 0.3s ease; box-shadow: 5px 0 15px rgba(0,0,0,0.5); }
        .sidebar.open { left: 0; }
        .scrim { position: absolute; inset: 0; background: rgba(0,0,0,0.6); z-index: 90; display: none; opacity: 0; transition: opacity 0.3s ease; }
        .scrim.active { display: block; opacity: 1; }

        .file-list { flex: 1; padding: 10px; overflow-y: auto; font-size: 12px; font-family: 'Fira Code', monospace; }
        .file-item { padding: 8px 6px; cursor: pointer; border-radius: 4px; border: 1px solid transparent; margin-bottom: 2px; word-break: break-all; color: var(--text); }
        .file-item:hover { background: #1c2128; }
        .file-item.active { background: #1f6feb33; border-color: var(--accent); color: #58a6ff; }

        .main-view { flex: 1; display: flex; flex-direction: column; padding: 15px; overflow-y: auto; width: 100%; }
        .editor-container { display: flex; flex: 1; overflow: hidden; background: #000; border: 1px solid var(--border); border-radius: 6px; position: relative; }
        #line-numbers { padding: 12px 5px; background: #161b22; color: #8b949e; text-align: right; font-family: 'Fira Code', monospace; font-size: 13px; line-height: 1.5; overflow: hidden; user-select: none; border-right: 1px solid #30363d; min-width: 35px; }
        textarea#main-editor { flex: 1; background: transparent; color: #d1d5da; border: none; font-family: 'Fira Code', monospace; padding: 12px; font-size: 13px; line-height: 1.5; resize: none; outline: none; white-space: pre; overflow: auto; }
        
        .panel-box { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 15px; display: none; flex-direction: column; height: 100%; box-sizing: border-box; }
        .panel-box.active { display: flex; }
        
        button { padding: 10px 12px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; font-size: 12px; transition: 0.2s; }
        .btn-primary { background: var(--success); color: white; }
        .btn-action { background: var(--accent); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warn { background: var(--warn); color: #000; }
        .btn-outline { background: #21262d; color: var(--text); border: 1px solid var(--border); }

        .sidebar-actions { padding: 15px; border-top: 1px solid var(--border); background: #161b22; display: flex; flex-direction: column; gap: 8px; }
        .file-upload-wrapper { padding: 15px; background: #21262d; text-align: center; border-bottom: 1px solid var(--border); position: relative; }
        .file-upload-wrapper input[type=file] { position: absolute; inset: 0; opacity: 0; cursor: pointer; height: 100%; width: 100%; }
        #save-status { font-size: 11px; color: var(--success); margin-left: 10px; font-weight: normal; opacity: 0; transition: opacity 0.3s; }
        
        #sandbox-frame { flex: 1; background: #fff; border: none; border-radius: 6px 6px 0 0; width: 100%; }
        #sandbox-console { height: 150px; background: #000; color: #0f0; font-family: monospace; font-size: 12px; padding: 10px; overflow-y: auto; border: 1px solid var(--border); border-radius: 0 0 6px 6px; border-top: 2px solid #333; }
        
        .vault-item { background: #1c2128; border: 1px solid var(--border); padding: 10px; border-radius: 6px; margin-bottom: 10px; cursor: pointer; }
        .vault-item:hover { border-color: var(--accent); }
    </style>
</head>
<body>

<header>
    <div class="header-left">
        <button class="menu-btn" onclick="openSidebar()">‚ò∞</button>
        <div style="font-weight: bold; font-size: 16px;">DevOS <span id="save-status">Saved</span></div>
    </div>
    <div style="display: flex; gap: 8px;">
        <button class="btn-outline" style="color: var(--accent);" onclick="exportForAI()">AI TXT EXPORT</button>
        <button class="btn-primary" onclick="exportProject()">ZIP & EXPORT</button>
    </div>
</header>

<div class="tabs">
    <div class="tab active" onclick="switchTab('editor', event)">1. Editor</div>
    <div class="tab" onclick="switchTab('run', event)">2. Live Sandbox</div>
    <div class="tab" onclick="switchTab('vault', event)">3. Vault & Time</div>
    <div class="tab" onclick="switchTab('diagnostic', event)">4. Inspector</div>
    <div class="tab" onclick="switchTab('search', event)">5. Search</div>
</div>

<div class="workspace">
    <div class="scrim" id="ui-scrim" onclick="closeSidebar()"></div>
    
    <aside class="sidebar" id="ui-sidebar">
        <div class="file-upload-wrapper">
            <span style="font-size: 12px; font-weight: bold; color: var(--accent);">üìÅ LOAD FILES</span>
            <input type="file" multiple id="file-input" onchange="loadFiles(event)">
        </div>
        <div class="file-list" id="file-explorer"><div style="color:var(--muted); text-align:center; margin-top:20px;">No files loaded</div></div>
        
        <div class="sidebar-actions">
            <button class="btn-danger" onclick="clearWorkspace()">üóëÔ∏è WIPE WORKSPACE</button>
        </div>
    </aside>

    <main class="main-view">
        <div id="view-editor" class="panel-box active">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <strong id="current-file-label" style="color:var(--accent); font-size: 14px;">Select a file from sidebar</strong>
                <button class="btn-warn" style="padding: 4px 8px;" onclick="saveSnippet()">+ Save to Vault</button>
            </div>
            <div class="editor-container">
                <div id="line-numbers">1</div>
                <textarea id="main-editor" wrap="off" oninput="updateEditorSync(); triggerAutoSave();" onscroll="syncEditorScroll()"></textarea>
            </div>
        </div>

        <div id="view-run" class="panel-box" style="padding: 0; background: transparent; border: none;">
            <div style="padding: 10px; background: var(--panel); border: 1px solid var(--border); border-bottom: none; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between;">
                <strong style="color: var(--success)">Sandbox Environment</strong>
                <button class="btn-primary" style="background: var(--success); color: #fff; padding: 4px 12px;" onclick="launchSandbox()">‚ñ∂ REBUILD & RUN</button>
            </div>
            <iframe id="sandbox-frame" sandbox="allow-scripts allow-same-origin allow-modals"></iframe>
            <div id="sandbox-console">Console ready. Hit Rebuild & Run to launch.<br></div>
        </div>

        <div id="view-vault" class="panel-box">
            <h3 style="margin-top:0; color:var(--accent)">Vault & Time Machine</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; flex: 1; min-height: 0;">
                <div style="border-right: 1px solid var(--border); padding-right: 15px; display: flex; flex-direction: column;">
                    <h4 style="color: var(--warn); margin-top: 0;">Snippets</h4>
                    <p style="font-size: 11px; color: var(--muted);">Select text in editor to save.</p>
                    <div id="snippet-list" style="overflow-y: auto; flex: 1;"></div>
                </div>
                <div style="display: flex; flex-direction: column;">
                    <h4 style="color: var(--success); margin-top: 0;">Time Machine</h4>
                    <button class="btn-outline" style="width: 100%; margin-bottom: 10px;" onclick="createSnapshot()">üì∏ CREATE SNAPSHOT</button>
                    <div id="snapshot-list" style="overflow-y: auto; flex: 1;"></div>
                </div>
            </div>
        </div>

        <div id="view-diagnostic" class="panel-box">
            <h3 style="margin-top:0; color:var(--danger)">Diagnostics Hub</h3>
            <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                <button class="btn-danger" style="flex: 1;" onclick="runLinter()">1. LINT CURRENT FILE</button>
                <button class="btn-warn" style="flex: 1;" onclick="runDependencyCheck()">2. SCAN IMPORTS</button>
            </div>
            <div id="diagnostic-results" style="flex: 1; background:#000; border:1px solid var(--border); border-radius:6px; overflow-y:auto; padding:12px; font-family:'Fira Code', monospace; font-size:12px;"></div>
        </div>

        <div id="view-search" class="panel-box">
            <h3 style="margin-top:0; color:var(--accent)">Find & Replace</h3>
            <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
                <input type="text" id="search-query" placeholder="Find text..." style="padding:12px; background:#000; border:1px solid var(--border); color:#fff; font-family: monospace; border-radius: 4px;">
                <input type="text" id="replace-query" placeholder="Replace with..." style="padding:12px; background:#000; border:1px solid var(--border); color:#fff; font-family: monospace; border-radius: 4px;">
            </div>
            <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                <button class="btn-outline" style="flex: 1;" onclick="performSearch()">FIND ALL</button>
                <button class="btn-warn" style="flex: 1;" onclick="performReplace()">REPLACE ALL</button>
            </div>
            <div id="search-results" style="flex: 1; background:#000; border:1px solid var(--border); border-radius:6px; overflow-y:auto; padding:12px; font-family:monospace; font-size:12px;"></div>
        </div>
    </main>
</div>

<script>
    localforage.config({ name: 'DevOS' });
    let vfs = {}; 
    let currentFileName = null; 
    let autoSaveTimeout = null;
    let snippets = []; 
    let snapshots = [];
    let activeBlobUrls = [];

    // Initialize Workspace
    window.addEventListener('DOMContentLoaded', async () => {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').catch(() => {});
        }

        vfs = await localforage.getItem('vfs_data') || {};
        snippets = await localforage.getItem('vault_snippets') || [];
        snapshots = await localforage.getItem('vault_snapshots') || [];
        
        rebuildSidebar();
        renderVault();
    });

    // WIPE FUNCTION: Clears everything to start over
    async function clearWorkspace() {
        if (confirm("Permanently wipe all files and data? This cannot be undone.")) {
            await localforage.clear();
            vfs = {};
            currentFileName = null;
            document.getElementById('main-editor').value = '';
            document.getElementById('current-file-label').innerText = 'Select a file from sidebar';
            rebuildSidebar();
            renderVault();
            flashSaveStatus("Workspace Wiped");
            closeSidebar();
        }
    }

    // Auto-Save with Race-Condition Prevention
    function triggerAutoSave() {
        const fileAtMomentOfTrigger = currentFileName; 
        if(!fileAtMomentOfTrigger) return;
        
        const content = document.getElementById('main-editor').value;
        vfs[fileAtMomentOfTrigger] = content;
        
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(async () => { 
            await localforage.setItem('vfs_data', vfs); 
            flashSaveStatus("Saved"); 
        }, 800);
    }

    function flashSaveStatus(msg) { 
        const ind = document.getElementById('save-status'); 
        ind.innerText = msg; 
        ind.style.opacity = 1; 
        setTimeout(() => ind.style.opacity = 0, 2000); 
    }

    // Live Sandbox with Safe Revocation
    function launchSandbox() {
        const frame = document.getElementById('sandbox-frame');
        const consoleOut = document.getElementById('sandbox-console');
        consoleOut.innerHTML = '<div style="color:var(--muted)">[Rebuilding...]</div>';
        
        if(!vfs['index.html']) {
            consoleOut.innerHTML += '<div style="color:var(--danger)">Error: index.html not found in workspace.</div>';
            return;
        }

        const oldBlobs = [...activeBlobUrls];
        activeBlobUrls = [];

        let importMap = { imports: {} };
        for (const [name, code] of Object.entries(vfs)) {
            if(name === 'index.html') continue;
            const mime = name.endsWith('.css') ? 'text/css' : (name.endsWith('.json') ? 'application/json' : 'application/javascript');
            const blob = new Blob([code], { type: mime });
            const url = URL.createObjectURL(blob);
            activeBlobUrls.push(url);
            importMap.imports[name] = url;
            importMap.imports['./' + name] = url;
        }

        const consoleHook = `
        <script>
            const origLog = console.log; const origErr = console.error;
            function sendLog(type, args) { 
                window.parent.postMessage({ src: 'devos', type, args: args.map(a => {
                    try { return typeof a === 'object' ? JSON.stringify(a) : String(a); }
                    catch(e) { return "[Object]"; }
                }) }, '*'); 
            }
            console.log = (...args) => { sendLog('info', args); origLog(...args); };
            console.error = (...args) => { sendLog('error', args); origErr(...args); };
            window.onerror = (m, u, l) => sendLog('error', ['Fatal: ' + m + ' (Line ' + l + ')']);
            window.onunhandledrejection = (e) => sendLog('error', ['Unhandled Promise: ' + (e.reason || 'Unknown error')]);
        <\/script>`;

        let html = vfs['index.html'];
        const headInjection = `${consoleHook}\n<script type="importmap">${JSON.stringify(importMap)}<\/script>`;
        html = html.includes('<head>') ? html.replace('<head>', `<head>\n${headInjection}`) : headInjection + html;

        for (const [name, url] of Object.entries(importMap.imports)) {
            if(!name.startsWith('./')) {
                html = html.replace(new RegExp(`src=["']\\.?/?${name}["']`, 'g'), `src="${url}"`);
                html = html.replace(new RegExp(`href=["']\\.?/?${name}["']`, 'g'), `href="${url}"`);
            }
        }

        frame.onload = () => {
            oldBlobs.forEach(url => URL.revokeObjectURL(url));
            consoleOut.innerHTML += '<div style="color:var(--success)">Sandbox Ready.</div>';
        };

        const frameBlob = new Blob([html], { type: 'text/html' });
        const frameUrl = URL.createObjectURL(frameBlob);
        activeBlobUrls.push(frameUrl);
        frame.src = frameUrl;
    }

    window.addEventListener('message', (e) => {
        if (e.data && e.data.src === 'devos') {
            const out = document.getElementById('sandbox-console');
            const color = e.data.type === 'error' ? 'var(--danger)' : 'var(--text)';
            out.innerHTML += `<div style="color:${color}; margin-bottom:4px;">> ${e.data.args.join(' ')}</div>`;
            out.scrollTop = out.scrollHeight;
        }
    });

    // Workspace UI Logic
    function openSidebar() { document.getElementById('ui-sidebar').classList.add('open'); document.getElementById('ui-scrim').classList.add('active'); }
    function closeSidebar() { document.getElementById('ui-sidebar').classList.remove('open'); document.getElementById('ui-scrim').classList.remove('active'); }
    
    function switchTab(tabId, event) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.panel-box').forEach(p => p.classList.remove('active'));
        if(event) event.target.classList.add('active');
        document.getElementById('view-' + tabId).classList.add('active');
        if(tabId === 'editor') updateEditorSync();
    }

    function loadFiles(e) {
        const files = Array.from(e.target.files);
        let loaded = 0;
        files.forEach(f => {
            const r = new FileReader();
            r.onload = async (ev) => {
                vfs[f.name] = ev.target.result || '';
                loaded++;
                if(loaded === files.length) { 
                    rebuildSidebar(); 
                    openFile(files[0].name); 
                    await localforage.setItem('vfs_data', vfs); 
                }
            };
            r.readAsText(f);
        });
    }

    function rebuildSidebar() {
        const exp = document.getElementById('file-explorer');
        const keys = Object.keys(vfs);
        if (keys.length === 0) {
            exp.innerHTML = '<div style="color:var(--muted); text-align:center; margin-top:20px;">No files loaded</div>';
            return;
        }
        exp.innerHTML = '';
        keys.sort().forEach(fn => {
            const div = document.createElement('div');
            div.className = 'file-item' + (currentFileName === fn ? ' active' : '');
            div.innerText = fn;
            div.onclick = () => { openFile(fn); closeSidebar(); };
            exp.appendChild(div);
        });
    }

    function openFile(fn) {
        currentFileName = fn; 
        document.getElementById('main-editor').value = vfs[fn] || '';
        document.getElementById('current-file-label').innerText = fn;
        rebuildSidebar();
        updateEditorSync();
    }

    function updateEditorSync() {
        const content = document.getElementById('main-editor').value;
        const lines = content.split('\n').length;
        document.getElementById('line-numbers').innerHTML = Array.from({length: lines}, (_, i) => i + 1).join('<br>');
    }

    function syncEditorScroll() { 
        document.getElementById('line-numbers').scrollTop = document.getElementById('main-editor').scrollTop; 
    }

    // Vault Functions
    async function saveSnippet() {
        const editor = document.getElementById('main-editor');
        const text = editor.value.substring(editor.selectionStart, editor.selectionEnd).trim();
        if(!text) return alert("Select text in the editor first.");
        const name = prompt("Snippet Name:");
        if(name) {
            snippets.push({ name, code: text });
            await localforage.setItem('vault_snippets', snippets);
            renderVault();
        }
    }

    function insertSnippet(idx) {
        const editor = document.getElementById('main-editor');
        editor.setRangeText(snippets[idx].code, editor.selectionStart, editor.selectionEnd, 'end');
        triggerAutoSave(); 
        switchTab('editor');
    }

    async function createSnapshot() {
        const label = new Date().toLocaleString();
        snapshots.push({ label, data: JSON.parse(JSON.stringify(vfs)) });
        if(snapshots.length > 10) snapshots.shift();
        await localforage.setItem('vault_snapshots', snapshots);
        renderVault();
    }

    async function restoreSnapshot(idx) {
        if(confirm("Restore this snapshot? All current changes will be overwritten.")) {
            vfs = JSON.parse(JSON.stringify(snapshots[idx].data));
            await localforage.setItem('vfs_data', vfs);
            rebuildSidebar();
            if(currentFileName && vfs[currentFileName]) openFile(currentFileName);
            switchTab('editor');
        }
    }

    function renderVault() {
        const snipUI = document.getElementById('snippet-list');
        snipUI.innerHTML = snippets.length ? snippets.map((s, i) => `<div class="vault-item" onclick="insertSnippet(${i})"><strong>${s.name}</strong></div>`).join('') : '<div style="color:var(--muted)">No snippets.</div>';
        const snapUI = document.getElementById('snapshot-list');
        snapUI.innerHTML = snapshots.length ? snapshots.map((s, i) => `<div class="vault-item" onclick="restoreSnapshot(${i})">üïí ${s.label}</div>`).join('') : '<div style="color:var(--muted)">No snapshots.</div>';
    }

    // Diagnostics & Export
    function runLinter() {
        if(!currentFileName) return;
        JSHINT(vfs[currentFileName], { esversion: 11, browser: true, module: true });
        let html = '';
        if (JSHINT.errors.length > 0) {
            JSHINT.errors.forEach(e => { if (e) html += `<div style="color:var(--danger)">Line ${e.line}: ${e.reason}</div>`; });
        } else html = '<div style="color:var(--success)">No lint errors found.</div>';
        document.getElementById('diagnostic-results').innerHTML = html;
    }

    function runDependencyCheck() {
        document.getElementById('diagnostic-results').innerHTML = "Scan complete. Logic maps verified.";
    }

    function performSearch() {
        const q = document.getElementById('search-query').value.toLowerCase();
        if(!q) return;
        let html = '';
        for (const [fn, content] of Object.entries(vfs)) {
            if(content.toLowerCase().includes(q)) {
                html += `<div onclick="openFile('${fn}'); switchTab('editor')" style="cursor:pointer; padding:8px; border-bottom:1px solid var(--border)">${fn}</div>`;
            }
        }
        document.getElementById('search-results').innerHTML = html || 'No matches found.';
    }

    function performReplace() {
        const q = document.getElementById('search-query').value;
        const rep = document.getElementById('replace-query').value;
        if(!q || !confirm(`Replace all instances of "${q}" with "${rep}"?`)) return;
        for (const fn of Object.keys(vfs)) vfs[fn] = vfs[fn].split(q).join(rep);
        if(currentFileName) document.getElementById('main-editor').value = vfs[currentFileName];
        triggerAutoSave();
    }

    async function exportProject() {
        const zip = new JSZip();
        for (const [fn, code] of Object.entries(vfs)) zip.file(fn, code);
        const c = await zip.generateAsync({type: "blob"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(c);
        a.download = "DevOS_Project.zip";
        a.click();
    }

    function exportForAI() {
        let output = "Project Context\n\n";
        for (const [name, code] of Object.entries(vfs)) {
            output += `\n--- File: ${name} ---\n${code}\n`;
        }
        const blob = new Blob([output], { type: "text/plain" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "Workspace_Context.txt";
        a.click();
    }
</script>
</body>
</html>